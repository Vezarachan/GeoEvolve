Robust Quantitative Susceptibility Mapping via
Approximate Message Passing with Parameter
Estimation
Shuai Huang1, James J. Lah2, Jason W. Allen1,2, and Deqiang Qiu∗1
1Department of Radiology and Imaging Sciences, Emory University, Atlanta, GA, 30322,
USA
2Department of Neurology, Emory University, Atlanta, GA, 30322, USA
Updated final version is accepted and available in “Magnetic Resonance in Medicine”:
https://doi.org/10.1002/mrm.29722
The code files for image reconstruction are available at:
https://github.com/EmoryCN2L/QSM_AMP_PE
∗This work is supported by National Institutes of Health under Grants R21AG064405, R01AG072603 and
P30AG066511. Corresponding author: Deqiang Qiu (deqiang.qiu@emory.edu).
1
arXiv:2207.14709v3  [eess.IV]  30 May 2023

Abstract
Purpose: For quantitative susceptibility mapping (QSM), the lack of ground-truth in clinical
settings makes it challenging to determine suitable parameters for the dipole inversion. We propose
a probabilistic Bayesian approach for QSM with built-in parameter estimation, and incorporate
the nonlinear formulation of the dipole inversion to achieve a robust recovery of the susceptibility
maps.
Theory: From a Bayesian perspective, the image wavelet coefficients are approximately sparse and
modelled by the Laplace distribution. The measurement noise is modelled by a Gaussian-mixture
distribution with two components, where the second component is used to model the noise outliers.
Through probabilistic inference, the susceptibility map and distribution parameters can be jointly
recovered using approximate message passing (AMP).
Methods: We compare our proposed AMP with built-in parameter estimation (AMP-PE) to the
state-of-the-art L1-QSM, FANSI and MEDI approaches on the simulated and in vivo datasets, and
perform experiments to explore the optimal settings of AMP-PE. Reproducible code is available at
https://github.com/EmoryCN2L/QSM_AMP_PE
Results: On the simulated Sim2Snr1 dataset, AMP-PE achieved the lowest NRMSE, DFCM and
the highest SSIM, while MEDI achieved the lowest HFEN. On the in vivo datasets, AMP-PE is
robust and successfully recovers the susceptibility maps using the estimated parameters, whereas
L1-QSM, FANSI and MEDI typically require additional visual fine-tuning to select or double-check
working parameters.
Conclusion: AMP-PE provides automatic and adaptive parameter estimation for QSM and avoids
the subjectivity from the visual fine-tuning step, making it an excellent choice for the clinical setting.
Keywords: Approximate message passing, Compressive sensing, Outlier modeling, Parameter
estimation, Quantitative susceptibility mapping
2

1
Introduction
The quantitative susceptibility mapping (QSM) technique recovers magnetic susceptibility from
magnetic resonance (MR) phase images [1–6]. It is widely used to study iron deposition in the
brain [7–9], or pathologies such as hemorrhage [10, 11] and calcification [12, 13]. Since the values
of raw phase images fall within (−π, π], the phases must first be unwrapped to eliminate the
discontinuity caused by the transition at π (or −π) [14]. To define the brain as the region of interest
(ROI), a binary brain mask can be generated using the Brain Extraction Tool [15].
Magnetic
field variations in the ROI are extracted from unwrapped phase images, and comprise 1) the
background field induced by global geometry, air–tissue interfaces and field inhomogeneities, and
2) the local field induced by the brain.
The background field is then removed to produce the
local field map [16,17]. Recovery of the susceptibility map χ from the local field map is known as
dipole inversion, an ill-posed inverse problem due to the zeros in the dipole kernel along the magic
angle [1, 18]. In this case, prior information about the susceptibility map is needed to improve
the image quality. In general, image gradients are assumed to be sparse and mostly close to zero.
This gives rise to the total-variation (TV) minimization approach that regularizes a data-fidelity
term using the l1-norm of image gradients [19–21]. In QSM, the TV-minimization approach often
incorporates anatomical information in the form of an edge-preserving mask obtained from the
gradients of the magnitude image [22]. Alternatively, image wavelet coefficients are also sparse
in general, allowing us to select the l1-norm of wavelet coefficients as the regularization term
instead [23–25].
The advantage of the wavelet basis over the total-variation basis is that the
wavelet transform is invertible, which offers us more freedom in developing suitable reconstruction
algorithms.
Apart from the ill-posedness of the dipole inversion, phase unwrapping errors also make the problem
challenging. Although the relationship between the phase and the susceptibility is linear, erroneous
phase jumps in the phase image can lead to severe streaking artifacts in QSM when a linear least-
squares data-fidelity term is used. To address these phase jumps, Liu et al. proposed a more robust
nonlinear least-squares data-fidelity term by mapping the phases of the local field to the complex
domain using the complex exponential function [14]. However, this non-linear data-fidelity term
leads to a nonconvex problem, making the solution dependent on initialization and susceptible to
getting trapped in local minima or diverging when the input phase spans a wide dynamic range.
Both the linear and nonlinear least-squares data-fidelity terms imply that the noise is modeled
as additive white Gaussian noise (AWGN). However, the AWGN models are assumed in different
domains: the linear data-fidelity term is in the phase domain, while the non-linear data-fidelity
term is in the complex MRI signal domain. Furthermore, noise outliers can be better modeled by
long-tailed distributions, such as the Gaussian-mixture distribution.
Regularization approaches, such as TV-minimization, use a parameter λ to balance the trade-off
between the data-fidelity term and the regularization term. The QSM reconstruction can have a
variety of noise profiles depending on the subject’s condition and the chosen processing pipeline.
3

When it is uncertain whether the noise profiles between the training and test sets would match,
using a pre-tuned (fixed) parameter might not be ideal. As a result, researchers have turned to
the L-curve method to find the parameter adaptively for each dataset [26, 27]. However, the L-
curve method is inherently heuristic, and there is no guarantee that the selected parameter will be
optimal. In practice, visual fine-tuning is typically used to find the working parameters or double-
check the pre-tuned parameters for in vivo reconstructions [28]. However, the parameters chosen
through visual fine-tuning are subjective and depend on the practitioner.
In this paper, we propose a probabilistic Bayesian approach to jointly recover the susceptibility
map and parameters. We use the Laplace distribution to encode the sparse prior on the wavelet
coefficients of susceptibility map, and a customized Gaussian-mixture distribution to model the
noise distribution. We compute the maximum-a-posteriori (MAP) estimations of the wavelet coef-
ficients and distribution parameters using approximate message passing (AMP) [29,30]. To handle
the phase unwrapping errors, we adopt the nonlinear measurement model where the complex ex-
ponential functions of phases are used as measurements. We then extend the standard linear AMP
so that it could be used to solve the nonlinear dipole inversion. In addition, we propose a morphol-
ogy mask for the image wavelet coefficients to incorporate anatomical structural information into
the reconstruction. Experiments show that the proposed AMP with built-in parameter estimation
(AMP-PE) is robust and successfully recovers susceptibility maps on both simulated and in vivo
datasets.
2
Theory
Let Bl denote the produced local field after phase unwrapping and background field removal, and
ϕe denote the corresponding phase at an echo time te. We have
ϕe = 2πγ · te · Bl + eu + ϕ0
= 2πγ · te · B0 · F ∗DF χ + eu + ϕ0
= Aeχ + eu + ϕ0 ,
(1)
where γ is the gyromagnetic ratio, ϕ0 is the initial phase offset that depends on the coil-sensitivity,
B0 is the main magnetic field, F is the Fourier transform matrix, D is the dipole kernel in the
frequency domain, χ is the magnetic susceptibility, eu is the noise, and Ae is the (combined) resulting
operator applied on χ. The initial phase ϕ0 can be estimated from the multi-echo phase images by
solving a nonlinear least-squares fitting problem [14]. In particular, the ill-posed dipole kernel D
is given by
D(k) =
( 1
3 −
k2
z
∥k∥2
2
0
if k ̸= 0
if k = 0 ,
(2)
where k = [kx ky kz]T is the spatial frequency component.
4

To achieve a robust recovery of the susceptibility χ, we adopt the following nonlinear forward model
proposed in [14]:
We · exp(iϕe) = We · exp(iAeχ) + u ,
(3)
where i is the imaginary unit, We is a diagonal weighting matrix, u is the noise. The complex
exponential function exp(iϕe) of the phase image ϕe could effectively reduce the discontinuity
caused by erroneous phase jumps [14]. However, the nonlinear forward model makes the problem
nonconvex, and the solution could get trapped in some local minima or diverge if it’s not properly
initialized. There are various methods for designing suitable weighting matrices, but in this case,
we can simply use the magnitude image as We. Although the AWGN model is loosened when
the weighting matrix We is used, experiments demonstrate that the proposed AMP-PE approach
can still adjust the estimated noise variance accordingly to fit the loosened AWGN model for a
successful recovery.
2.1
Bayesian Formulation
The sparse prior on the wavelet coefficients v of the susceptibility χ is used to improve the image
quality:
v = Hχ ,
(4)
where H is the invertible wavelet transform matrix. As shown in Fig. 1(a), we use the sparsity-
promoting Laplace distribution to model the distribution of wavelet coefficients. The coefficients
in v are assumed to be independent and identically distributed (i.i.d.):
p(v|λ) = 1
2λ · exp(−λ|v|) ,
(5)
where λ > 0 is the unknown distribution parameter.
As shown in Fig. 1(b), we propose the following Gaussian-mixture distribution with two components
to model the noise distribution
p(u|ξs, τs) =
2
X
s=1
ξs · CN(u|0, τs),
(6)
where ξs is the s-th mixture weight, τs is the s-th variance, the mixture means are zeros, and CN(·)
is the complex Gaussian density function. The number of Gaussian mixtures needs to be chosen
carefully to avoid overfitting during reconstruction. From the experiments later in Section 4, we
observe that using two Gaussian mixtures produces the best performance. The second Gaussian
component CN(u|0, τ2) is used to model the noise outliers that give rise to a long-tailed distribution.
The variance τ2 of the second Gaussian component should be large enough to cover the domain of
u. In practice, we can initialize the second variance τ2 with a larger value than the first variance
5

(a) Laplace distribution
(b) Gaussian-mixture distribution
Figure 1: The prior distributions in the probabilistic Bayesian formulation: (a) the image wavelet
coefficients are sparse and modeled by the Laplace distribution; (b) the noise is modeled by the
Gaussian-mixture distribution with two components, the second Gaussian component is used to
model the noise outliers.
τ1.
Under the Bayesian formulation, we can recover χ by computing its MAP estimation
bχ = arg max
χ
p(χ|y) ,
(7)
where y contains the measurements, and p(χ|y) is the posterior distribution of χ that can be
computed via approximate message passing (AMP) [29].
2.2
Approximate Message Passing with Parameter Estimation
AMP was originally designed for the linear measurement system [29]. In order to apply it for the
nonlinear dipole inversion, we need to linearize it iteratively using the zero-th and first orders of
Taylor series [14]. Letting χ(r) denote the susceptibility in the r-th iteration, we have the following
linear approximation in the (r + 1) iteration:
We · exp(iϕe) = iWe · exp

iAeχ(r)
· Aeχ −g

χ(r)
+ u ,
(8)
where g
 χ(r)
= We · exp
 iAeχ(r)
·
 iAeχ(r) −1

is a relative constant that depends on χ(r).
Rewriting the above (8) in the form of a linear measurement model, we have
We · exp(iϕe) + g

χ(r)
= iWe · exp

iAeχ(r)
· Aeχ + u ,
(9)
where We·exp(iϕe)+g
 χ(r)
become the linear measurements, and iWe·exp
 iAeχ(r)
·Ae becomes
the corresponding measurement matrix. We can then recover χ(r+1) using AMP based on the linear
approximation in (9).
As shown by the factor graph in Fig. 2, the distribution parameters {λ, θ} are treated as random
6

Signal prior
The 1st echo
The E-th echo
Noise prior
λ
v1
vN
...
Ω1
ΩN
...
χ1
χN
...
Ψ1
ΨN
...
θ1
θK
...
Φ11
Φ1M
...
ΦE1
ΦEM
...
Figure 2: The factor graph of the QSM task: “⃝” represents the variable node, and “■” represents
the factor node. In particular, λ is the signal prior parameter, θ = {ξ1, ξ2, τ1, τ2} contains the noise
prior parameters.
7

variables and jointly recovered with the signals of interest {v, χ} [30].
The variable nodes are
represented by “⃝” and contain random variables.
The factor nodes are represented by “■”
and encode the probability distributions of random variables. The messages about the variable
distributions are passed and discussed among the factor nodes until a consensus is reached.
For example, we use the following notations to denote the messages between the n-th variable node
χn and the m-th factor node Φem in the e-th echo:
• ∆χn→Φem denotes the message from χn to Φem,
• ∆Φem→χn denotes the message from Φem to χn,
where n ∈{1, · · · , N}, e ∈{1, · · · , E} and m ∈{1, · · · , M}. Both ∆χn→Φem and ∆Φem→χn are
functions of the variable χn, and are expressed in the “log” domain in this paper. A derivation of the
AMP algorithm is beyond the scope of this paper, and algorithmic details can be found in [29,30].
A detailed introduction to AMP is included in Section S-I of the Supporting Information.
Once the message passing converges, we can calculate the distributions of the variables using
the messages. For example, the posterior distribution p(χn|y) is proportional to the exponential
function of the summation of all the messages passed to χn [31,32]:
p(χn|y) ∝exp
 
∆Ψn→χn +
X
em
∆Φem→χn
!
.
(10)
Currently, the convergence of the AMP algorithm has only been established for random Gaussian
measurement matrices [29]. Extending the convergence analysis to general measurement matrices
is still an open question. In practice, damping and mean-removal operations are used to ensure the
convergence of AMP for non-Gaussian matrices [33,34]. For the ill-posed measurement operator in
(8), which contains the dipole kernel, we perform the damping operation on χ to stabilize AMP.
Let χ(t)
d
denote the damped susceptibility in the t-th iteration, and χ(t+1) denote the undamped
susceptibility in the (t + 1)-th iteration. The MAP estimation of the n-th entry χn in χ is
χ(t+1)
n
= arg max
χn
p(χn|y) = arg max
χn
∆(t+1)
Ψn→χn +
X
em
∆(t+1)
Φem→χn .
(11)
We can compute the damped solution χ(t+1)
d
as follows
χ(t+1)
d
= χ(t)
d + α ·

χ(t+1) −χ(t)
d

,
(12)
where α ∈(0, 1] is the damping rate on the susceptibility χ. For the QSM task, we need to choose
a small damping rate α to be around 0.01.
As discussed in [30], we can estimate the parameter λ of the sparse signal prior by maximizing its
8

posterior:
bλ = arg max
λ
p(λ|y) = arg max
λ
X
n
∆Ωn→λ ,
(13)
where the posterior distribution p(λ|y) can be computed via AMP.
The estimation of the noise prior parameters requires additional work. Due to the ill-posedness of
the measurement operator, the MAP method tends to over-estimate the weight ξ2 of the second
Gaussian component, which is reserved for the noise outliers. To overcome this issue, we propose
a two-step procedure to estimate the mixture weights ξ1, ξ2:
1) Perform a preliminary reconstruction with only one Gaussian component CN(u|0, τ0) to model
the noise.
bτ0 = arg max
τ0
p(τ0|y) = arg max
τ0
X
em
∆Φem→τ0 .
(14)
2) Estimate the weights {ξ1, ξ2} of the two-component Gaussian mixture based on the prelimi-
nary reconstruction χ0. We first calculate the residual error ϵ using χ0:
ϵe = We exp(iϕe) −We exp(iAeχ0) .
(15)
We next use ϵe to approximate the noise u, and treat the residue entries that fall outside
[−3τ0, 3τ0] as outliers. The weights ξ1 and ξ2 can then be estimated as
bξ1 =
1
EM
X
em
1(|ϵem| ≤3τ0),
(16)
bξ2 = 1 −bξ1 ,
(17)
where 1(·) is the indicator function.
With the estimated weights bξ1, bξ2 fixed, we can estimate the Gaussian mixture variances τ1, τ2 by
maximizing their posteriors:
bτs = arg max
τs
p(τs|y) = arg max
τs
X
em
∆Φem→τs,
s = 1, 2.
(18)
When computing the MAP estimations of the parameters λ, τ1, τ2, we also need to use damping
operations to overcome the ill-posedness of the dipole kernel and stabilize AMP. In the (t + 1)-th
9

Magnitude image
Wavelet coefficients
0
50
100
150
Figure 3: The magnitude image and its wavelet coefficients obtained using the db2 wavelet basis
with 3 levels of decomposition.
iteration, we have
bλ(t+1)
d
= bλ(t)
d + β ·

bλ(t+1) −bλ(t)
d

,
(19)
bτs
(t+1)
d
= bτs
(t)
d + β ·

bτ (t+1)
s
−bτs
(t)
d

,
(20)
where bλ(t)
d , bτs
(t)
d
are the damped parameters in the (t)-th iteration, bλ(t+1) and bτ (t+1)
s
are the un-
damped MAP estimations computed via (13) and (18) in the (t + 1)-th iteration, β ∈(0, 1] is the
damping rate on the estimated parameters. For the QSM task, we can choose β to be around 0.1.
2.3
Morphology Mask for the Wavelet Coefficients
To incorporate anatomical information into the reconstruction process, we propose a new mor-
phology mask Mv that can be applied on the wavelet coefficients v of the susceptibility map χ.
The purpose of using a morphology mask is to preserve the high-frequency information that cor-
responds to the edges of anatomical structures. The wavelet transform applies a series of low-pass
and high-pass filters on the image, generating the wavelet coefficients that provide a natural way
of identifying edge information. As shown in Fig. 3, the wavelet coefficients z of the magnitude
image reveal the anatomical structures in a hierarchical manner, and those significant coefficients
correspond to the structural edges. Since the anatomical structures are consistent between the
magnitude image and the susceptibility map, the indices of significant wavelet coefficients should
also be consistent between z of the magnitude image and v of the susceptibility map. We can set
a threshold µ on z to generate the morphology mask Mv, which we can then apply on v to avoid
penalizing significant coefficients during reconstruction.
Let S denote the set of indices of the wavelet coefficients in z ∈RN whose absolute values are
larger than the magnitude threshold µ:
S = {i | |z(i)| > µ, where 1 ≤i ≤N} .
(21)
10

The value of µ is selected with respect to the l1-norm ∥z∥1 such that
P
i∈S |z(i)|
∥z∥1
= c ,
(22)
where 0 < c < 1 is the percentage threshold, which is defined by the percentage of top wavelet
coefficients with respect to ∥z∥1.
A larger c leads to more high-frequency information in the
recovered susceptibility map, while a smaller c leads to more low-frequency information. In practice,
we can set c to be around 0.85 for in vivo reconstructions.
The binary 0 −1 morphology mask Mv for the wavelet coefficients v is then
Mv(i) =
(
1
0
if i ∈S
otherwise.
(23)
When the wavelet coefficients v of the susceptibility map are modeled by the Laplace distribution
as in (5), the MAP estimation of v under the AMP formulation is obtained through the soft-
thresholding operator Tκ(·) [35].
Tκ(v) =
(
(|v| −κ) · sign(v)
0
if |v| > κ
if |v| ≤κ,
(24)
where κ is the soft threshold specified by the AMP algorithm. The soft-thresholding operator Tκ(·)
essentially penalizes the magnitude of individual coefficient.
By utilizing the morphology mask Mv, we ensure that coefficients belonging to the set S are not
penalized, which helps preserving high-frequency edge information. Let v(t) denote the solution
from the (t)-th iteration. In the (t + 1)-th iteration, we then have
v(t+1)(i) =
(
v(t)(i)
Tκ
 v(t)(i)

if i ∈S
otherwise.
∀1 ≤i ≤N .
(25)
3
Methods
We compare the proposed AMP-PE approach with the state-of-the-art L1-QSM [28], FANSI [27,36]
and MEDI [14] approaches on the 2019 QSM challenge 2.0 dataset and the in vivo 3D brain datasets.
Specifically, the L1-QSM, FANSI and MEDI approaches adopt the total-variation regularization
11

and solve the following nonlinear dipole inversion problems:
L1-QSM:
min
χ
∥We (exp (iAeχ) −exp (iϕe))∥1 + η · ∥Gχ∥1,
(26)
FANSI:
min
χ
∥We (exp (iAeχ) −exp (iϕe))∥2
2 + ζ · ∥Gχ∥1,
(27)
MEDI:
min
χ
ρ ·
c
We (exp (iAeχ) −exp (iϕe))

2
2 + ∥MgGχ∥1,
(28)
where G(·) is the gradient operator that computes image gradients, Mg is a 0-1 morphology
mask and only selects the gradients that correspond to non-edges; η, ζ and ρ are the regularization
parameters. The L1-QSM and FANSI approaches use the magnitude image as the weighting matrix
We, while the MEDI approach constructs c
We based on the reliability of the measurements and
iteratively updates it according to the residual.
In order to showcase the robustness of using
complex exponential measurements We exp(iϕe), we also recover QSM using the conventional linear
measurements Weϕe. The results from the linear recovery approach are given in Section S-V of
the Supporting Information.
In the clinical setting, we could not perform parameter-tuning for QSM due to the lack of ground-
truth across different processing pipelines, acquisition protocols and scanners.
For the FANSI
approach, we followed the guidelines in [27] and used the heuristic L-curve method to determine
the parameter ζ from the set {10(−1.5−i∗0.1) | i = 1, · · · , 25}, as suggested by the script provided in
the FANSI toolbox. The maximum number of iterations was set to 300, with a convergence rate of
1e−3. Additionally, we set the Lagrangian weight in the total-variation subproblem to µ1 = 100ζ,
and the weight in the data-fidelity term subproblem to µ2 = 1. The curvature data of the L-
curve was smoothed using a median filter, and the inflection point where the curvature changes
sign was selected as the parameter. If the L-curve method fails to produce a suitable parameter,
we perform visual fine-tuning. For the L1-QSM approach, we followed the same guidelines as the
FANSI approach. The optimal parameter η is generally larger than that of FANSI, and is thus
selected from the set {10(−0.5−i∗0.1) | i = 1, · · · , 20}. For the MEDI approach, the L-curve method
cannot be used in this case since the weighting matrix We in (28) is iteratively updated with
respect to the residue, which introduces additional variability to the data-fidelity term that alters
the shape of the L-curve. Therefore, we used the tuned parameter ρ = 1000, as suggested by the
MEDI-toolbox [14].
Unlike other approaches that use the total-variation regularization, AMP-PE uses a sparse prior
on the image wavelet coefficients to improve image quality. We use the Daubechies wavelet family
to obtain the sparse representation of the susceptibility map [23]. The orthogonal “db1–db10”
wavelet bases are typically used, with the complexity of a wavelet basis increasing with its order.
For image recovery, we use a wavelet transform with three levels of decomposition. Specifically,
the db1 wavelet is suitable for capturing low-frequency information in the image, while higher-
order wavelet bases are better suited for capturing high-frequency information. Although we aim
to retain the structural details of the susceptibility map encoded in the high-frequency bands,
12

streaking artifacts also contain predominantly high-frequency information. Therefore, we need to
find a suitable basis that balances the trade-off between low and high frequencies. As discussed in
Section 2.3, we apply the proposed morphology mask Mv on the wavelet coefficients to incorporate
anatomical information into the reconstruction. The mask Mv is determined by the percentage
threshold c in (22). The larger the threshold c is, the more high-frequency information will be
retained in the susceptibility map.
• For the simulated Sim2Snr1 dataset, much of the ground-truth susceptibility map is piecewise
constant and contains more low-frequency information. Thus, the db1 wavelet is a better
choice in this case, and the percentage threshold c is set to 0.75.
• For the in vivo datasets, the susceptibility map contains a lot of fine structural details that
cannot be fully captured by the db1 wavelet, and the more complex db2 wavelet basis can be
chosen instead. Higher-order wavelet bases such as db3 could capture more details from the
streaking artifacts, and are generally not recommended for the QSM task. The percentage
threshold c is set to 0.85.
3.1
The Simulated Sim2Snr1 Dataset from the QSM Challenge 2.0
The QSM reconstruction challenge 2.0 (Seoul 2019) provides the simulated Sim2Snr1 dataset with
a ground-truth susceptibility map for evaluation [37]. The dataset contains an intra-hemispheric
calcification that creates strong dephasing effect and is thus more challenging.
The simulation
parameters are as follows: the main magnetic field B0 = 7 T, repetition time (TR) = 50 ms; echo
time (TE) TE1/TE2/TE3/TE4 = 4/12/20/28 ms; echo spacing = 8 ms; the flip angle = 15°; field
of view (FoV) = 164×205×205 mm3 and 1 mm3 isotropic voxels. The Gaussian noise is added to
the complex data, producing a peak SNR of 100. Since only the brain tissues are used to simulate
the field perturbations, the background field removal is not needed.
As recommended in [27,28], the L1-QSM and FANSI approaches used the provided frequency map
with a simulated TE of 10 ms to recover the susceptibility map. As recommended by the MEDI-
toolbox [14], the MEDI approach used the provided frequency map with a simulated TE equalling
the echo spacing (i.e. 8 ms) to recover the susceptibility map. In contrast, the AMP-PE approach
used all the unwrapped phase images obtained from 4 echoes to recover the susceptibility map.
3.2
in vivo 3D Brain Dataset
We acquired in vivo 3D brain data from healthy subjects on a 3T MRI scanner (Prisma model,
Siemens Healthcare, Erlangen, Germany), with the written consent obtained before imaging. In
addition, we conducted a retrospective chart review study to obtain clinical MR images from
patients with hemorrhage under the approval of the Institutional Review Board of Emory University.
The patient scans were performed using a 3T MRI scanner (Tim Trio model, Siemens Healthcare,
Erlangen, Germany). We reconstructed susceptibility maps from both the healthy subject scans
and patient scans with brain hemorrhage. The data were acquired using GRE sequences with the
following acquisition parameters:
13

• Five healthy subject scans (H1–H5). We have the main magnetic field B0 = 3 T, the flip
angle = 15°, the number of echoes = 4, the first echo time = 7.32 ms, echo spacing = 8.68
ms, TR = 38 ms, slice thickness = 0.7 mm, in-plane resolution = 0.6875 mm × 0.6875 mm,
bandwidth per pixel = 260 Hz, and acquisition matrix size = 320 × 320 × 208.
• One patient scan with hemorrhage (P1). We have the main magnetic field B0 = 3 T, the flip
angle = 15°, the number of echoes = 6, the first echo time = 7.5 ms, echo spacing = 7.6 ms,
slice thickness = 1.8887 mm, in-plane resolution = 0.9375 mm × 0.9375 mm, and acquisition
matrix size = 184 × 256 × 80.
• Two patient scans with hemorrhage (P2,P3). We have the main magnetic field B0 = 3 T,
the flip angle = 15°, the number of echoes = 4, the first echo time = 6.35 ms, echo spacing =
6.05 ms, TR = 35 ms, slice thickness = 2 mm, in-plane resolution = 0.71875 mm × 0.71875
mm, and acquisition matrix size = 260 × 320 × 72.
The initial phase ϕ0 was estimated using the complex fitting method available in the MEDI tool-
box, and then removed from the raw phase images. The resulting multi-echo phase images were
unwrapped using the 3D best-path phase unwrapping algorithm [38]. After unwrapping, the multi-
echo phase images were divided by their respective echo times and combined to generate an average
total field (in Hz). The averaged total field was then transformed to the phase domain (in radians)
using a TE that equals the echo-spacing, resulting in a combined phase image. To remove the back-
ground field from the combined phase image, we utilized the projection onto dipole fields (PDF)
method [16]. The processed phase image (after background field removal) was the converted to the
corresponding local field map (in Hz). In order to attain optimal performance from the L1-QSM,
FANSI, and MEDI approaches, the local field map was mapped to the phase image (in radians) at
a simulated TE to recover the susceptibility map. As recommended by the FANSI toolbox, a TE of
20 ms was used for the in vivo reconstruction by the L1-QSM and FANSI approaches. The MEDI
approach, on the other hand, used the echo spacing as the recommended TE. However, the echo
spacing may vary among different acquisition protocols. In order to verify that MEDI achieved
optimal performance under the current experimental setting, we conducted experiments where the
simulated TE varied from 1 ms to 20 ms.
On the other hand, as shown in Fig. 2, AMP-PE naturally supports the use of multi-echo phase
images as measurements.
For the AMP-PE approach, instead of processing a combined phase
image, we applied PDF on the unwrapped multi-echo phase images individually to remove the
background field. We then used the processed multi-echo phase images from all the echoes directly
to recover the susceptibility as before.
During the background field removal and the linear/nonlinear dipole inversion, a phase-based qual-
ity mask was also applied to remove voxels with unreliable phase values [39].
In particular, if
there were holes inside the brain mask, we need to fill them during background field removal, and
reintroduce the holes during dipole inversion.
14

3.3
An investigation of the optimal settings of AMP-PE
As previously discussed, the optimal settings for AMP-PE differ between the simulated Sim2Snr1
dataset and the in vivo datasets. Specifically, we investigated the following three settings of AMP-
PE:
1) The choice of whether to enforce the ROI mask on χ by setting the susceptibility outside the
ROI to 0 during dipole inversion.
2) The choice of the sparsifying wavelet basis.
3) The choice of the percentage threshold c of the morphology mask Mv for wavelet coefficients.
We showcase the effect of each choice through the following three experiments:
1) We compare the recovered susceptibility maps with and without the ROI mask enforced on
χ. For the Sim2Snr1 dataset, we used the db1 wavelet basis, and set the percentage threshold
c to 75%. For the in vivo dataset H1, we used the db2 wavelet basis, and set the percentage
threshold to 85%.
2) We compare the recovered susceptibility maps using different wavelet bases. For the Sim2Snr1
dataset, we enforced the ROI mask on χ, set the percentage threshold c to 75%, and selected
wavelet bases from db1 and db2. For the in vivo dataset H1, we did not enforce the ROI
mask on χ, set the percentage threshold c to 85%, and selected wavelet bases from db1, db2,
db3, and db6.
3) We compare the recovered susceptibility maps using different percentage thresholds c. For the
Sim2Snr1 dataset, we enforced the ROI mask on χ, used the db1 wavelet basis, and selected
percentage thresholds from 50%, 75%, 80%, and 85%. For the in vivo dataset H1, we did not
enforce the ROI mask on χ, used the db2 wavelet basis, and selected percentage thresholds
from 80%, 85%, 90%, and 95%.
4
Results
4.1
The Simulated Sim2Snr1 Dataset from the QSM challenge 2.0
Using the code provided by the QSM challenge 2.0, we computed several evaluation metrics, includ-
ing the normalized root mean square error (NRMSE), ROI-based detrend error metrics 1 for tissue,
blood, and deep gray matter (DGM), calcification error metrics that include calcification streaking
(CalcStreak) and deviation from calcification moment (DFCM), structural similarity index measure
(SSIM), and high-frequency error norm (HFEN). The evaluation metric scores are shown in Table
1, and the reconstructed QSMs are shown in Fig. 4. The corresponding error maps are shown in
Fig. S2 of the Supporting Information. In general, the FANSI and AMP-PE approaches outperform
the L1-QSM approach. In terms of global metrics, AMP-PE achieves the lowest NRMSE and the
1The detrend NRMSE compensates for potential “systematic underestimation” and “demeaning global shifts” in
susceptibility within the region considered.
15

Table 1: The simulated Sim2Snr1 dataset: evaluation metric scores of the recovered susceptibility
maps using different approaches. The best performance under each metric is in boldface.
detrend NRMSE
Methods
NRMSE
Tissue
Blood
DGM
CalcStreak
DFCM
SSIM
HFEN
L1-QSM (L-curve)
51.01
50.86
150.29
29.74
8.17e-2
28.21
0.550
58.85
L1-QSM (Visual)
35.01
33.23
91.50
18.08
3.21e-2
15.03
0.795
33.58
FANSI (L-curve)
30.93
32.99
65.43
17.90
1.00e-2
12.79
0.790
29.67
MEDI (Default)
35.13
33.35
81.75
20.60
1.95e-2
11.21
0.775
25.28
AMP-PE
30.86
33.48
64.95
18.15
1.30e-2
7.74
0.811
28.91
 
MEDI:
 FANSI (L-curve):
Groundtruth
L1-QSM (L-curve):
AMP-PE
ppm
-0.1
0
0.1
ζ=3.98e-4
η=6.31e-2
η=2.00e-2
L1-QSM (visual fine-tuning):
ρ=1000
Figure 4: The Sim2Snr1 dataset: recovered susceptibility maps using the L1-QSM, nonlinear
FANSI, MEDI, and AMP-PE approaches.
16

highest SSIM, MEDI achieves the lowest HFEN. In terms of region-specific metrics, each approach
has its own strong suit: FANSI achieves the lowest detrend NRMSE on the tissue and DGM, and
the lowest CalcStreak; AMP-PE achieves the lowest detrend NRMSE on the blood, and the lowest
DFCM.
Following the guidelines in [27], we used the heuristic L-curve method to select the parameters for
the L1-QSM and FANSI approaches respectively. The corresponding curvature curves are shown in
Fig. S21 and S30 in the Supporting Information. As shown in Fig. 4, the parameter η of L1-QSM
selected by the L-curve method was not optimal and over-regularized the recovered susceptibility
map, visual fine-tuning was further employed to find a working parameter for L1-QSM.
4.2
in vivo 3D Brain Dataset
The recovered susceptibility maps for the healthy scan “H1” and hemorrhage scan “P1” are shown
in Fig. 5–6. Additional QSMs from “H2–H5” and “P2-P3” are show in Fig. S3-S6 and S7-S8 in the
Supporting Information. For the L1-QSM and FANSI approaches, although the L-curve method
proved effective on the simulated Sim2Snr1 dataset, the parameters derived from this method over-
regularized the reconstructions on the in vivo datasets, leading to a loss of finer details in the
recovered maps. The corresponding curvature curves are shown in Fig. S22-S29 and S31-S38 in
the Supporting Information. As suggested in [36], visual fine-tuning was employed to determine
working parameters when the L-curve method failed.
However, the parameters determined by
visual fine-tuning are subjective and dependent on the practitioner. For the MEDI approach, the
default parameter ρ = 1000 was used. Fig. 7 shows the susceptibility maps recovered by MEDI
when the local field (in Hz) is mapped to the phase images at different echo times. To ensure
the best performance of MEDI, we need to double-check the results through visual fine-tuning as
well. We can see that the default parameter produces the best results when the chosen TE is set
to 8 ∼10ms, which is consistent with the current experimental setting. On the other hand, the
proposed AMP-PE recovers the susceptibility maps directly from the processed multi-echo phase
images after phase unwrapping and background field removal. AMP-PE estimates the parameters
from the data automatically and adaptively, with no need for visual fine-tuning.
The reconstructions of susceptibility maps are performed on the MATLAB platform using a machine
(Intel Xeon Gold 5218 Processor, 2.30GHz) with 200 Gb RAM. We compared the runtime of each
method on the healthy scan “H1”. The L1-QSM and FANSI approaches took 4.7 and 3.5 minutes
respectively for a single run, they took a total of 94.3 and 85.8 minutes respectively to complete the
l-curve analysis of 20 and 25 parameter choices. The MEDI and AMP-PE approaches took 11.2
and 53.2 minutes respectively to complete the reconstruction.
4.3
An investigation of the optimal settings of AMP-PE
For the Sim2Snr1 dataset, the recovered susceptibility maps using AMP-PE under the three set-
tings in Section 3.3 are shown in Fig. S26-S27 in the Supporting Information, the corresponding
evaluation metric scores are given in Table S2 in the Supporting Information. We can see that the
17

 
 
MEDI:
FANSI (L-curve):
FANSI (visual fine-tuning):
AMP-PE
ρ=1000
ζ=2.00e-3
ζ=2.00e-4
L1-QSM (L-curve):
L1-QSM (visual fine-tuning):
η=3.98e-2
η=2.00e-2
-0.1
0.1
ppm
Figure 5: Healthy scan (H1): recovered susceptibility maps using the L1-QSM approach, nonlinear
FANSI, MEDI, and AMP-PE with the db2 wavelet basis.
18

 
 
MEDI:
FANSI (L-curve):
FANSI (visual fine-tuning):
AMP-PE
ρ=1000
ζ=2.00e-3
ζ=2.00e-4
L1-QSM (L-curve):
L1-QSM (visual fine-tuning):
η=6.31e-2
η=2.00e-2
-0.1
0.1
ppm
Figure 6: Patient scan (P1): recovered susceptibility maps using the L1-QSM approach, nonlinear
FANSI, MEDI, and AMP-PE with the db2 wavelet basis.
19

 
 
15 ms
8 ms
10 ms
20 ms
1 ms
5 ms
-0.1
0.1
ppm
Figure 7: The recovered susceptibility maps using the MEDI approach when the local field (in Hz)
is mapped to the phase images at different echo times. Through visual fine-tuning, we can see that
the default parameter ρ = 1000 produces the best results when the chosen TE is set to 8 ∼10 ms.
20

best results are obtained when the ROI mask is enforced on χ, the db1 wavelet basis is used, and
the percentage threshold c is set to 75%.
For the in vivo dataset H1, the recovered susceptibility maps using AMP-PE under the three
settings in Section 3.3 are shown in Fig. 8-9 respectively. Due to the absence of ground-truth in
the in vivo case, we assessed the recovered susceptibility maps through visual inspection. We can
see that the best results are obtained when the ROI mask is “not” enforced on χ, the db2 wavelet
basis is used, and the percentage threshold c is set to 85%.
21

ROI-mask off
ROI-mask on
-0.1
0.1
ppm
(a) The choice of enforcing the ROI mask on the susceptibility map
 
db3 basis
db1 basis
db2 basis
db6 basis
(b) The choice of different wavelet bases
Figure 8: The H1 dataset: the recovered susceptibility maps and their error maps using the AMP-
PE approach with different choices of settings.
22

 
c = 80%
-0.1
0.1
ppm
c = 85%
c = 90%
c = 95%
Figure 9: The H1 dataset: the recovered susceptibility maps and their error maps using the AMP-
PE approach when the percentage threshold c of the morphology mask Mg is chosen from 80%,
85%, 90% and 95%.
23

5
Discussion
The L-curve method has previously been used to compute the regularization parameter. However,
due to its heuristic nature, it is not robust enough to handle varying signal and noise conditions. The
L-curve was initially proposed for the least-squares data-fidelity term with Tikhonov regularization
(i.e. the squared l2-norm) and achieved relatively robust performance [26]. However, when it was
used for the l1-norm regularization in FANSI, the computed parameter may not be close to the
optimal parameter, since the statistical property of the l1-norm is different from that of the squared
l2-norm. To address this issue, the L-curve method was combined with visual fine-tuning in [28]
for in vivo reconstructions. This requires human intervention and produces subjective results. In
this paper, we propose the Bayesian approach for QSM reconstruction that allows us to estimate
the parameters adaptively and automatically. The estimated parameters maximize their posterior
distributions, which avoids the subjectivity introduced by visual fine-tuning.
For the simulated Sim2Snr1 dataset, the local field map is derived solely from the brain tissue within
the ROI. As shown in Fig. S39(a) and Table S2, it is therefore beneficial to enforce the binary
brain ROI-mask on χ during the dipole inversion. However, for practical in vivo reconstructions, the
background field removal process would not be perfect, and there is still some residue background
field left within the ROI. As shown in Fig. 4.3, enforcing the ROI-mask on χ leads to incorrect
susceptibility variations. By allowing the susceptibility outside the ROI to account for the residual
background field, we can obtain a significantly improved susceptibility map in the in vivo case.
The forward model under the AMP framework is essentially constructed with respect to the trans-
form coefficients v of the susceptiblity map χ. To recover χ from v, the sparsifying transform
applied to the image must be invertible. In this paper, we employ the wavelet transform to obtain
the sparse representation of the image in the form of wavelet coefficients.
Although the total-
variation transform is not invertible and therefore cannot be utilized, the db1 wavelet shrinkage
with a single level is equivalent to a single step of total-variation regularization [40]. Fig. 8 shows
the susceptibility maps recovered using AMP-PE with various wavelet bases. As the wavelet basis
order increases, more high-frequency information can be captured. The db1 basis cannot capture
enough high-frequency information, leading to pixelation effects in the recovered map. In contrast,
the db6 basis captures high-frequency information from both the image and streaking artifacts (see
the coronal views in Fig. 8). For the in vivo reconstruction, we can either simply employ the db2
basis for reconstruction or average the susceptibility maps obtained using the db1 and db2 bases
if resources permit. However, we must note that the db2 basis may not be the optimal choice
for other MRI tasks. For example, in the case of T1 and T ∗
2 mappings, which do not involve the
removal of streaking artifacts, the db6 basis was used in [41] to obtain the optimal reconstruction
of T ∗
2 maps.
The use of a morphology mask Mg in TV regularization was first proposed by Liu et al. in the
MEDI approach [22], it can also be used in other TV regularization approaches, such as FANSI.
24

By penalizing non-edge gradients, the structural information can be incorporated through the
morphology mask Mg. The edges in the susceptibility map recovered by MEDI are thus better
preserved, which leads to a significantly lower HFEN. Inspired by this, we proposed a morphology
mask Mv that can be applied on the wavelet coefficients in Section 2.3. This mask enables us to
separate the high-frequency information of structural edges from that of streaking artifacts in the
wavelet domain. As shown in Fig. 9, we can set the percentage threshold c at around 85% to
generate a suitable mask for the in vivo reconstruction.
As shown in Fig. 1(b), we employ the two-component Gaussian-mixture distribution to model the
noise in QSM. The second component of the mixture model is used to handle noise outliers caused
by phase unwrapping errors or brain hemorrhage and calcification. In the Supporting Information,
Fig.
S41(a) shows a comparison of the recovered susceptibility maps when we used the (one-
component) Gaussian distribution and the (two-component) Gaussian-mixture to model the noise
in the case of phase unwrapping errors. We can see that AMP-PE with a Gaussian-mixture noise
prior is better at removing the streaking artifact than AMP-PE with a single-Gaussian noise prior.
As discussed in Section 2.2, the ill-posed dipole kernel causes AMP-PE to overestimate the weight
ξ2 of the second Gaussian component. To address this problem, we propose a two-step procedure
whereby ξ1, ξ2 are first estimated based on a preliminary reconstruction and then fixed in the final
reconstruction. The left plot of Fig. S41(b) shows the recovered map by the standard procedure
where ξ1, ξ2 are freely updated; and the right plot of Fig. S41(b) shows the recovered map by the
proposed two-step procedure where the streaking artifacts are removed more effectively and the
images are cleaner.
The convergence of AMP has been established for random Gaussian measurement matrices. How-
ever, for non-Gaussian measurement matrices, damping and mean-removal operations are necessary
to ensure convergence. Since the means of rows of the transform operator Ae in (1) are approx-
imately zero, the mean of the resulting measurement operator in (8) is also approximately zero.
Therefore, we do not need to perform the mean-removal operation in this case. However, the dis-
tribution p(Ae) of the entries in Ae is not Gaussian. For example, in the simple case where the size
of Ae is 103 × 103, the normal probability plot in Fig. S42 of the Supporting Information shows
that p(Ae) is both left- and right-skewed with discontinuity in the distribution, and the histogram
in Fig. S42 confirms that p(Ae) is quite different from the Gaussian distribution. As discussed in
Section 2.2, we used damping operations on the estimated susceptibility and parameters to achieve
the convergence of AMP. Furthermore, since the QSM reconstruction is a nonconvex problem, ini-
tialization also plays a critical role in stabilizing the AMP algorithm. Our experiments have shown
that good performance can be achieved when the susceptibility was initialized with a zero vector,
while the parameters were initialized by performing a simple maximum-likelihood fitting of the
least-squares solution.
25

6
Conclusion
We propose a probabilistic Bayesian formulation to recover susceptibility maps from nonlinear
complex exponential measurements that are robust to phase errors. To model the noise outliers,
we adopt a custom two-component Gaussian mixture noise prior. Our approach also employs a
sparsity-promoting Laplace signal prior on the image wavelet coefficients to improve the image
quality. We use the proposed AMP with automatic and adaptive parameter estimation (AMP-PE)
to recover the susceptibility map. Additionally, we introduce a morphology mask on the image
wavelet coefficients to incorporate anatomical structural information into the reconstruction. Our
in vivo experiments demonstrate that AMP-PE is robust and successfully recovers susceptibility
maps with estimated parameters. Whereas the L1-QSM, FANSI and MEDI methods typically rely
on visual fine-tuning to select or double-check working parameters for different MR protocols and
scanners. The proposed AMP-PE is equipped with built-in parameter estimation and avoids the
subjectivity from the visual fine-tuning step, making it an excellent choice for the clinical setting.
DATA AVAILABILITY STATEMENT
The source code from this paper is openly available at: https://github.com/EmoryCN2L/QSM_
AMP_PE
References
[1] Y. Wang and T. Liu, “Quantitative susceptibility mapping (qsm): Decoding mri data for a
tissue magnetic biomarker,” Magnetic Resonance in Medicine, vol. 73, no. 1, pp. 82–101, 2015.
[2] C. Langkammer, T. Liu, M. Khalil, C. Enzinger, M. Jehna, S. Fuchs, F. Fazekas, Y. Wang,
and S. Ropele, “Quantitative susceptibility mapping in multiple sclerosis,” Radiology, vol. 267,
no. 2, pp. 551–559, 2013.
[3] A. Deistung, A. Sch¨afer, F. Schweser, U. Biedermann, R. Turner, and J. R. Reichenbach,
“Toward in vivo histology: A comparison of quantitative susceptibility mapping (qsm) with
magnitude-, phase-, and r2∗-imaging at ultra-high magnetic field strength,” NeuroImage,
vol. 65, pp. 299–314, 2013.
[4] J. H. O. Barbosa, A. C. Santos, V. Tumas, M. Liu, W. Zheng, E. M. Haacke, and C. E. G.
Salmon, “Quantifying brain iron deposition in patients with parkinson’s disease using quan-
titative susceptibility mapping, r2 and r2*,” Magnetic Resonance Imaging, vol. 33, no. 5,
pp. 559–565, 2015.
[5] M. J. Betts, J. Acosta-Cabronero, A. Cardenas-Blanco, P. J. Nestor, and E. D¨uzel, “High-
resolution characterisation of the aging brain using simultaneous quantitative susceptibility
mapping (qsm) and r2* measurements at 7t,” NeuroImage, vol. 138, pp. 43–63, 2016.
26

[6] D. Qiu, G.-F. Chan, J. Chu, Q. Chan, S.-Y. Ha, M. Moseley, and P.-L. Khong, “Mr quantitative
susceptibility imaging for the evaluation of iron loading in the brains of patients with β-
thalassemia major,” American Journal of Neuroradiology, vol. 35, no. 6, pp. 1085–1090, 2014.
[7] C. Langkammer, F. Schweser, N. Krebs, A. Deistung, W. Goessler, E. Scheurer, K. Sommer,
G. Reishofer, K. Yen, F. Fazekas, S. Ropele, and J. R. Reichenbach, “Quantitative suscepti-
bility mapping (qsm) as a means to measure brain iron? a post mortem validation study,”
NeuroImage, vol. 62, no. 3, pp. 1593–1599, 2012.
[8] F. Schweser, K. Sommer, A. Deistung, and J. R. Reichenbach, “Quantitative susceptibility
mapping for investigating subtle susceptibility variations in the human brain,” NeuroImage,
vol. 62, no. 3, pp. 2083–2100, 2012.
[9] W. Li, B. Wu, and C. Liu, “Quantitative susceptibility mapping of human brain reflects spatial
variation in tissue composition,” NeuroImage, vol. 55, no. 4, pp. 1645–1656, 2011.
[10] Y. Zhang, H. Wei, Y. Sun, M. J. Cronin, N. He, J. Xu, Y. Zhou, and C. Liu, “Quantitative
susceptibility mapping (qsm) as a means to monitor cerebral hematoma treatment,” Journal
of Magnetic Resonance Imaging, vol. 48, no. 4, pp. 907–915, 2018.
[11] H. Sun, A. C. Klahr, M. Kate, L. C. Gioia, D. J. Emery, K. S. Butcher, and A. H.
Wilman, “Quantitative susceptibility mapping for following intracranial hemorrhage,” Ra-
diology, vol. 288, no. 3, pp. 830–839, 2018.
[12] A. Deistung, F. Schweser, B. Wiestler, M. Abello, M. Roethke, F. Sahm, W. Wick, A. M. Nagel,
S. Heiland, H.-P. Schlemmer, M. Bendszus, J. R. Reichenbach, and A. Radbruch, “Quantitative
susceptibility mapping differentiates between blood depositions and calcifications in patients
with glioblastoma,” PLOS ONE, vol. 8, pp. 1–8, 03 2013.
[13] W. Chen, W. Zhu, I. Kovanlikaya, A. Kovanlikaya, T. Liu, S. Wang, C. Salustri, and Y. Wang,
“Intracranial calcifications and hemorrhages: Characterization with quantitative susceptibility
mapping,” Radiology, vol. 270, no. 2, pp. 496–505, 2014.
[14] T. Liu, C. Wisnieff, M. Lou, W. Chen, P. Spincemaille, and Y. Wang, “Nonlinear formulation
of the magnetic field to source relationship for robust quantitative susceptibility mapping,”
Magnetic Resonance in Medicine, vol. 69, no. 2, pp. 467–476, 2013.
[15] S. M. Smith, “Fast robust automated brain extraction,” Human Brain Mapping, vol. 17, no. 3,
pp. 143–155, 2002.
[16] T. Liu, I. Khalidov, L. de Rochefort, P. Spincemaille, J. Liu, A. J. Tsiouris, and Y. Wang,
“A novel background field removal method for mri using projection onto dipole fields (pdf),”
NMR in Biomedicine, vol. 24, no. 9, pp. 1129–1136, 2011.
27

[17] F. Schweser, A. Deistung, B. W. Lehr, and J. R. Reichenbach, “Quantitative imaging of
intrinsic magnetic tissue properties using mri signal phase: An approach to in vivo brain iron
metabolism?,” NeuroImage, vol. 54, no. 4, pp. 2789–2807, 2011.
[18] E. M. Haacke, S. Liu, S. Buch, W. Zheng, D. Wu, and Y. Ye, “Quantitative susceptibility
mapping: current status and future directions,” Magnetic Resonance Imaging, vol. 33, no. 1,
pp. 1–25, 2015.
[19] L. I. Rudin, S. Osher, and E. Fatemi, “Nonlinear total variation based noise removal algo-
rithms,” Physica D: Nonlinear Phenomena, vol. 60, no. 1, pp. 259–268, 1992.
[20] D. Strong and T. Chan, “Edge-preserving and scale-dependent properties of total variation
regularization,” Inverse Problems, vol. 19, pp. S165–S187, nov 2003.
[21] A. Chambolle, “An algorithm for total variation minimization and applications,” Journal of
Mathematical Imaging and Vision, vol. 20, pp. 89–97, 01 2004.
[22] J. Liu, T. Liu, L. de Rochefort, J. Ledoux, I. Khalidov, W. Chen, A. J. Tsiouris, C. Wisnieff,
P. Spincemaille, M. R. Prince, and Y. Wang, “Morphology enabled dipole inversion for quan-
titative susceptibility mapping using structural consistency between the magnitude image and
the susceptibility map,” NeuroImage, vol. 59, no. 3, pp. 2560–2568, 2012.
[23] I. Daubechies, Ten lectures on wavelets. Philadelphia, PA, USA: Society for Industrial and
Applied Mathematics, 1992.
[24] E. J. Cand`es, J. K. Romberg, and T. Tao, “Stable signal recovery from incomplete and in-
accurate measurements,” Communications on Pure and Applied Mathematics, vol. 59, no. 8,
pp. 1207–1223, 2006.
[25] A. Y. Yang, A. Ganesh, Z. Zhou, S. S. Sastry, and Y. Ma, “A review of fast l1-minimization
algorithms for robust face recognition,” CoRR, vol. abs/1007.3753, 2010.
[26] P. C. Hansen, “The l-curve and its use in the numerical treatment of inverse problems,” in in
Computational Inverse Problems in Electrocardiology, ed. P. Johnston, Advances in Computa-
tional Bioengineering, pp. 119–142, WIT Press, 2000.
[27] C. Milovic, C. Prieto, B. Bilgic, S. Uribe, J. Acosta-Cabronero, P. Irarrazaval, and C. Tejos,
“Comparison of parameter optimization methods for quantitative susceptibility mapping,”
Magnetic Resonance in Medicine, vol. 85, no. 1, pp. 480–494, 2021.
[28] C. Milovic, M. Lambert, C. Langkammer, K. Bredies, P. Irarrazaval, and C. Tejos, “Streaking
artifact suppression of quantitative susceptibility mapping reconstructions via l1-norm data
fidelity optimization (l1-qsm),” Magnetic Resonance in Medicine, vol. 87, no. 1, pp. 457–473,
2022.
28

[29] S. Rangan, “Generalized approximate message passing for estimation with random linear mix-
ing,” in Proceedings of IEEE ISIT, pp. 2168–2172, July 2011.
[30] S. Huang and T. D. Tran, “Sparse signal recovery using generalized approximate message
passing with built-in parameter estimation,” in Proceedings of IEEE ICASSP, pp. 4321–4325,
March 2017.
[31] M. J. Wainwright and M. I. Jordan, “Graphical models, exponential families, and variational
inference,” Foundations and Trends in Machine Learning, vol. 1, pp. 1–305, Jan. 2008.
[32] T. P. Minka and R. Picard, A Family of Algorithms for Approximate Bayesian Inference. PhD
thesis, Massachusetts Institute of Technology, USA, 2001. AAI0803033.
[33] S. Rangan, P. Schniter, and A. Fletcher, “On the convergence of approximate message passing
with arbitrary matrices,” in Proceedings of IEEE ISIT, pp. 236–240, 2014.
[34] J. Vila, P. Schniter, S. Rangan, F. Krzakala, and L. Zdeborov´a, “Adaptive damping and mean
removal for the generalized approximate message passing algorithm,” in Proceedings of IEEE
ICASSP, pp. 2021–2025, 2015.
[35] F. Bellili, F. Sohrabi, and W. Yu, “Generalized approximate message passing for massive mimo
mmwave channel estimation with laplacian prior,” IEEE Transactions on Communications,
vol. 67, no. 5, pp. 3205–3219, 2019.
[36] C. Milovic, B. Bilgic, B. Zhao, J. Acosta-Cabronero, and C. Tejos, “Fast nonlinear susceptibil-
ity inversion with variational regularization,” Magnetic Resonance in Medicine, vol. 80, no. 2,
pp. 814–821, 2018.
[37] Q. C. . O. Committee, B. Bilgic, C. Langkammer, J. P. Marques, J. Meineke, C. Milovic,
and F. Schweser, “Qsm reconstruction challenge 2.0: Design and report of results,” Magnetic
Resonance in Medicine, vol. 86, no. 3, pp. 1241–1255, 2021.
[38] H. S. Abdul-Rahman, M. A. Gdeisat, D. R. Burton, M. J. Lalor, F. Lilley, and C. J. Moore,
“Fast and robust three-dimensional best path phase unwrapping algorithm,” Appl. Opt.,
vol. 46, pp. 6623–6635, Sep 2007.
[39] A. Karsa, S. Punwani, and K. Shmueli, “An optimized and highly repeatable mri acquisition
and processing pipeline for quantitative susceptibility mapping in the head-and-neck region,”
Magnetic Resonance in Medicine, vol. 84, no. 6, pp. 3206–3222, 2020.
[40] G. Steidl, J. Weickert, T. Brox, P. Mr´azek, and M. Welk, “On the equivalence of soft wavelet
shrinkage, total variation diffusion, total variation regularization, and sides,” SIAM Journal
on Numerical Analysis, vol. 42, no. 2, pp. 686–713, 2005.
29

[41] S. Huang, J. J. Lah, J. W. Allen, and D. Qiu, “A probabilistic bayesian approach to recover
r2* map and phase images for quantitative susceptibility mapping,” Magnetic Resonance in
Medicine, vol. 80, pp. 1624–1642, 2022.
30

Supporting Information
Additional Supporting Information may be found online in the Supporting Information section.
Supporting Table S1
The simulated Sim2Snr1 dataset: evaluation metric scores of the recov-
ered susceptibility maps using the linear recovery approach.
Supporting Table S2
The simulated Sim2Snr1 dataset: evaluation metric scores of the recov-
ered susceptibility maps using AMP-PE under different settings.
Supporting Figure S1
The factor graph of the sparse signal recovery task under the AMP
framework: “⃝” represents the variable node, and “■” represents the factor node.
Supporting Figure S2
The Sim2Snr1 dataset: the error maps using the L1-QSM, FANSI,
MEDI, and AMP-PE approaches.
Supporting Figures S3–S6
Healthy scan (H2–H5): recovered susceptibility maps using the
L1-QSM approach, nonlinear FANSI, MEDI, and AMP-PE with the db2 wavelet basis.
Supporting Figures S7,S8
Patient scan (P2, P3): recovered susceptibility maps using the
L1-QSM approach, nonlinear FANSI, MEDI, and AMP-PE with the db2 wavelet basis.
Supporting Figure S9
The Sim2Snr1 dataset: recovered susceptibility map and its error maps
using the linear recovery approach.
Supporting Figure S10, S11
The recovered susceptibility maps using the linear recovery ap-
proach with different choices of settings.
Supporting Figures S12–S20
The Sim2Snr1 and in vivo datastes: the linear recovery ap-
proach. Left subfigure: the L-curve that shows the log-fidelity-cost vs. the log-regularization-cost.
Right subfigure: the curvatures on the L-curve with respect to the corresponding regularization
weights. The median-filtered curvatures are used to determine the inflection point where the cur-
vature changes its sign.
Supporting Figures S21–S29
The Sim2Snr1 and in vivo datastes: The L1-QSM approach.
Left subfigure: the L-curve that shows the log-fidelity-cost vs. the log-regularization-cost. Right
subfigure: the curvatures on the L-curve with respect to the corresponding regularization weights.
The median-filtered curvatures are used to determine the inflection point where the curvature
changes its sign.
31

Supporting Figures S30–S38
The Sim2Snr1 and in vivo datastes: the nonlinear FANSI ap-
proach. Left subfigure: the L-curve that shows the log-fidelity-cost vs. the log-regularization-cost.
Right subfigure: the curvatures on the L-curve with respect to the corresponding regularization
weights. The median-filtered curvatures are used to determine the inflection point where the cur-
vature changes its sign.
Supporting Figure S39
The Sim2Snr1 dataset: the recovered susceptibility maps and their
error maps using the AMP-PE approach with different choices of settings: (a) the choice of enforcing
the ROI mask on the susceptibility map; (b) the choice of different wavelet bases.
Supporting Figure S40
The Sim2Snr1 dataset: the recovered susceptibility maps and their
error maps using the AMP-PE approach when the percentage threshold c of the morphology mask
Mg is chosen from 50%, 75%, 80% and 85%.
Supporting Figure S41
(a) The Gaussian-mixture noise prior is able to model the noise out-
liers and thus better at removing the streaking artifacts from recovered susceptibility map; (b)
AMP-PE achieves better performance with the two-step procedure where the Gaussian-mixture
weights are first estimated based on a preliminary reconstruction and then fixed during then final
reconstruction.
Supporting Figure S42
The distribution of the entries in the transform operator Ae: (a) The
normal probability plot compares the sample distribution to the normal distribution: all the N
sample entries are sorted and plotted on the x-axis, and the y-axis represents the corresponding
quantiles of the distribution with respect to each entry. For the i-th sorted entry on the x-axis, its
y-axis value is i−0.5
N ; (b) The histogram of the N entries.
32
