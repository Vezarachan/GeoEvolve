1
Distance Estimation Methods for a Practical
Macroscale Molecular Communication System
Fatih Gulec, Baris Atakan
Abstract
Accurate estimation of the distance between the transmitter (TX) and the receiver (RX) in molecular
communication (MC) systems can provide faster and more reliable communication. In addition, distance
information can be used in determining the location of the molecular source in practical applications
such as monitoring environmental pollution. Existing theoretical models in the literature are not suitable
for distance estimation in a practical scenario. Furthermore, deriving an analytical model is not easy due
to effects such as boundary conditions in the diffusion process, the initial velocity of the molecules and
unsteady ﬂows. Therefore, ﬁve different practical methods comprising three novel data analysis based
methods and two supervised machine learning (ML) methods, Multivariate Linear Regression (MLR)
and Neural Network Regression (NNR), are proposed for distance estimation at the RX side. In order to
apply the ML methods, a macroscale practical MC system, which consists of an electric sprayer without
a fan, alcohol molecules, an alcohol sensor and a microcontroller, is established, and the received signals
are recorded. A feature extraction algorithm is proposed to utilize the measured signals as the inputs
in ML methods. The numerical results show that the ML methods outperform the data analysis based
methods in the root mean square error sense with the cost of complexity. The nearly equal performance
of MLR and NNR shows that the input features such as peak time, peak concentration and the energy
of the received signal have a highly linear relation with the distance. Moreover, the peak time based
estimation, which is one of the proposed data analysis based methods, yields better results with respect
to the other proposed four methods, as the distance increases. Given the experimental data and ﬂuid
dynamics theory, a possible trajectory of the molecules between the TX and RX is given. Our ﬁndings
show that distance estimation performance is jointly affected by unsteady ﬂows and the non-linearity of
the sensor. According to our ﬁndings based on ﬂuid dynamics, it is evaluated that ﬂuid dynamics should
be taken into account for more accurate parameter estimation in practical macroscale MC systems.
Index Terms
Molecular Communication, Distance Estimation, Molecular Signal Processing.
F. Gulec and B. Atakan are with the Department of Electrical and Electronics Engineering, Izmir Institute of Technology,
35430, Urla, Izmir, Turkey (e-mail: fatihgulec@iyte.edu.tr, barisatakan@iyte.edu.tr).
arXiv:1909.12897v1  [eess.SP]  27 Sep 2019

2
I. INTRODUCTION
Molecular communication (MC) is a promising multiscale communication paradigm which uses molec-
ular signals to transmit and receive information symbols. Biological cells use MC in microscale for several
reasons such as ﬁnding a nutritional source or coordinating their activities as a swarm or network.
It is essential to share information among the cells via MC to form a network [1]. The developing
bio/nanotechnology enables the production of micro and nanoscale devices that mimic living cells, which
are called nanomachines (NMs). What makes MC prominent is that it performs complex tasks by forming
a nanonetwork, which is established by the interconnection of the NMs [2], [3]. These nanonetworks can
be used in the human body for applications such as targeted drug delivery and immune system support
[4].
MC can also be employed in macroscale (cm to m). In nature, animals like bees, ﬂies or ants use MC
to send messages over several meters with the help of the pheromones. Similar to the existing methods in
nature, pheromones can be exploited for long range communication among NMs as proposed in [5]. On
the other hand, the macroscale MC concept was employed in a practical MC system, which consists of
an electric sprayer controlled by a microcontroller as the transmitter (TX), a metal-oxide alcohol sensor
connected to a microcontroller as the receiver (RX) and alcohol molecules as the messenger molecules,
to send information symbols over a few meters [6]. The channel and noise models are proposed for this
macroscale MC system in [7] and [8]. It was observed that there is a nonlinearity in the channel which
differs from conventional communication systems. A similar MC system is proposed to be employed in
conﬁned structural environments consisting of several pipe types. It was shown that MC provides reliable
communication, whereas electromagnetic wave based communication cannot [9]. The data rate of the
practical MC system can be increased by multiple input multiple output (MIMO) MC system conﬁguration
as proposed and experimentally shown in [10] and [11]. In these two papers, an air compressor is used
instead of a fan to emit molecules. In [12], a method to mitigate inter-symbol interference is proposed
for an experimental MC system similar to the platform given in [6], except the fan behind the TX.
[13] proposes to employ an odor generator as the TX and a mass spectrometer with a quadrupole mass
analyzer as the RX for macroscale MC.
The macroscale experimental studies focus mostly on channel modeling which does not agree with
theoretical studies in the literature. However, except the propagation delay, these channel models do not
clearly state the relationship among the physical parameters such as the distance between the TX and RX
or the number of released molecules by the TX. By knowing the distance before the communication starts,
a higher communication rate can be achieved via arranging the parameters such as the number of released

3
molecules [14]–[17]. Furthermore, the deployment of the receivers can be arranged autonomously in a
nanonetwork with the distance information known by the RX. The distance estimation can also be used
to ﬁnd the location of a molecular source in various environmental monitoring applications. Therefore, it
is important to estimate the distance between the TX and RX, which is the main purpose of this paper.
The ﬁrst proposed distance estimation protocols are based on two-way transmission. In [18], four
distance estimation protocols are proposed which are based on measuring the round trip time (RTT) and
signal fading in amplitude or frequency for a 1-D diffusion channel. In these protocols, the TX transmits
a signal and the RX transmits a feedback signal with a different type of molecule, when the transmitted
signal is received. Then, the TX estimates the distance, when it receives the feedback signal. These
protocols are expanded in [19]. The RTT protocol is improved for a 2-D diffusion channel with a more
realistic microscale MC model in [20]. Since using feedback signals is time consuming and increases
interference in the communication channel, it is reasonable to estimate the distance at the RX side with
a single transmission. Accordingly, two distance estimation schemes with a one-way transmission are
proposed in [21]. Here, the RX measures the received peak concentration or the time interval between
the ﬁrst and second peaks to estimate the distance. These schemes require less time with respect to two-
way transmission protocols, but they are derived for a 1-D diffusion channel, and the estimation accuracy
is not improved signiﬁcantly. In [22], a lower bound for distance estimation accuracy is derived for the
diffusion channel without any ﬂow and initial drift. In another study, two distance estimation schemes,
where emission time is considered as a parameter, are proposed for a 3-D scenario in a diffusion channel
[23]. The ﬁrst scheme uses the peak time of the received signal, and the second scheme, which gives
more accurate results, uses the received energy to estimate the distance. The same authors propose
an algorithmic distance estimation scheme and two parameter optimization methods in [24] for a 3-D
diffusion channel. When compared with [23], this scheme has a worse distance estimation performance,
requires a more complex receiver and needs more time for estimation. In [25], a distance estimation
protocol is proposed to estimate the distance in a 3-D diffusion channel in the presence of additive noise
and inter-symbol interference by using maximum likelihood estimation. This proposed method has a high
accuracy with a cost of high complexity.
All of the distance estimation methods in the literature consider an ideal microscale channel model
where the transmitted molecules do not have an initial velocity, the molecules move according to Brownian
motion, there is no gravity, and the TX transmits and the RX receives the signals perfectly. However, this
channel model is not realistic for macroscale MC. Furthermore, there is no distance estimation method
for macroscale situations in the literature. In this paper, we propose ﬁve distance estimation methods for
a practical macroscale scenario, where molecules propagate indoors with an initial velocity and without

4
any constant ﬂow in a 3-D medium, i.e., air. Three of the proposed methods are novel data analysis
based methods, and two of them include supervised machine learning (ML) methods. To collect data for
the purpose of using them in these methods, an experimental setup similar to the tabletop platform in
[6] is employed. In this setup, an electric sprayer without a fan is the TX that emits alcohol molecules
and a metal-oxide alcohol sensor is the RX. The TX and RX are controlled with a microcontroller via
a computer to record the received signals. A novel algorithm is proposed to extract features from the
measured signals by the RX. For the ﬁrst time, the distance estimation is made with supervised ML
methods for a practical macroscale MC system. Multivariate linear regression (MLR) and neural network
regression (NNR) are used as ML methods which use the extracted features as inputs. The experimental
data are used as the training and test data of these methods. Afterwards, the collected data are analyzed
and three distance estimation methods are proposed which are less complex but less accurate than ML
methods. The ﬁrst data analysis based method is power based distance estimation, which employs the
relation between the distance and the received power to transmitted power ratio. In the second data analysis
based method, which is the peak time based distance estimation, the relation between the peak time of
the received signal and the distance is exploited. At long distances (170 cm and longer), this method
has the best results among the data analysis based methods. Combined distance estimation is the third
method, which uses a combination of the power based and peak time based estimation. Furthermore, all
of these applied methods are compared by discussing the numerical results. It is shown that ML methods
perform better than the data analysis based methods.
The existing theoretical models which are based on the diffusion of the molecules are insufﬁcient to
explain the experimental results. It is difﬁcult to consider all of the effects such as turbulent ﬂows and
boundary conditions of the molecule movements for deriving an analytical expression to estimate the
distance. This gives us the motivation to employ ML and data analysis based methods to estimate the
distance as detailed in Section II. Moreover, an analysis is made on the experimental data. Experimental
ﬁndings show that the movement of the molecules in a practical scenario is also affected by some ﬂows
accompanying diffusing molecules. In particular, the analyses reveal that unsteady ﬂows can affect the
propagation of the molecules in addition to the Brownian motion, even if there is no fan behind the
TX. Correspondingly, a possible trajectory of the transmitted molecules in the communication channel is
given. In addition, our analysis based on experimental ﬁndings indicate that the non-linear characteristic
of the sensor can cause measurement errors at lower distances. The main result of these analyses is
that a ﬂuid dynamics perspective is needed for channel modeling and parameter estimation in MC for
macroscale practical scenarios. Also, open research directions are indicated by analyzing the numerical
results.

5
The rest of the paper is organized as follows. In Section II, the motivation for using the ML and
data analysis based methods is given. In Section III, the experimental setup, which is used for data
collection, is explained. The proposed feature extraction algorithm is given in Section IV. The supervised
ML methods, which are applied to estimate the distance in this paper, are brieﬂy introduced in Section
V. In Section VI, the proposed distance estimation methods based on data analysis are given. In Section
VII, the numerical results for the implemented methods are presented and compared. Moreover, received
signals and the motion of the molecules are analyzed with a ﬂuid dynamics perspective. Finally, the
concluding remarks are given in Section VIII.
II. MOTIVATION
In this section, the motivation of using ML and data analysis based methods for distance estimation
in a practical macroscale scenario is given. When the theoretical model of the molecule concentration
with respect to time and space is known, the distance between the TX and RX can easily be estimated
by measuring other parameters for a MC channel such as molecule concentration, number of transmitted
molecules, propagation time of the molecules and the diffusion coefﬁcient. Our experimental setup, which
is detailed in Section III, includes a sprayer as the TX, ethyl alcohol (ethanol) as messenger molecules
and an alcohol sensor as the RX. There is not a fan behind the TX to create a constant ﬂow and the
molecules propagate with an initial velocity in the air. The theoretical models in the literature consider
that the transmitted molecules only diffuse in the medium with or without a constant ﬂow. However, these
models are not realistic for practical scenarios due to the following reasons. Firstly, boundary conditions
and the types of the boundaries, i.e., absorber or reﬂector, should be taken into account. Secondly, alcohol
is initially sprayed with an initial velocity as liquid droplets rather than alcohol molecules. Therefore,
only Brownian motion cannot be sufﬁcient to characterize the movement of molecules.
The molecule concentration with respect to time at the RX side does not comply with the existing
theoretical models, when the molecules are transmitted with an initial velocity as in our case. The
equations for these models are given below in (1) and (2) for only diffusion [26] and diffusion with
constant ﬂow [7], respectively.
C(t) =
Q
(4πDt)3/2 e−d2
4Dt .
(1)
C(t) =
Qd
√
4πDt3 e−(vt−d)2
4Dt .
(2)
In these equations, C(t) is the molecule concentration, Q is the number of the transmitted molecules, d
is the distance from the TX, D is the diffusion coefﬁcient, t is the propagation time of the molecules and
v is the velocity of the constant ﬂow in the medium. In Fig. 1, a comparison of the theoretical models

6
with the experimental results are given by showing the normalized molecule concentration change in
time at a distance d = 100 cm. In order to see the waveforms more clearly, the normalization is made
by dividing C(t) to the peak concentration value. In Fig. 1(a), the molecules only diffuse according to
(1). In Fig. 1(b), the model in (2) is applied in a medium with a constant ﬂow, whose velocity is taken
as the experimental average velocity of the molecules at d = 100 cm.
0
1
2
3
4
5
6
7
8
9
10
Time (s)
104
0
0.2
0.4
0.6
0.8
1
Normalized Molecule Concentration
Diffusion
0
2
4
6
8
10
12
14
16
18
20
Time (s)
0
0.2
0.4
0.6
0.8
1
Normalized Molecule Concentration
Diffusion with Flow
0
2
4
6
8
10
12
14
16
18
20
Time (s)
0
0.2
0.4
0.6
0.8
1
Normalized Molecule Concentration
Experimental
(a)
(b)
(c)
Fig. 1: Comparison of the theoretical models for normalized molecule concentrations as a function of
time at d = 100 cm with experimental results: (a) Diffusion, (b) Diffusion with ﬂow, (c) Experimental
results (D = 0.1149980886 cm2/s, v = 23.53 cm/s).
As shown with the experimental results in Fig.1(c), the models in (1) and (2) do not give accurate
results for the molecule concentration as a function of time in a practical situation. The diffusion model
in (1) approximates the shape of C(t), but the peak time differs very much from the experimental result
due to the effect of the initial velocity. Also, the diffusion with ﬂow model in (2) gives the peak time
approximately, when the average velocity of the molecules is known. However, the shape of the function
C(t) is very different from the experimental results. In addition, the solution of the general advection-
diffusion equation can be employed to model the molecule concentration as given by [13]
C(x, y, z, t) =
mt
(4πt)3/2p
DxDyDz
e−
(x−(x0+vxt))2
4Dxt
−(y−(y0+vyt))2
4Dyt
−
(z−(z0+vzt))2
4Dzt
,
(3)
where mt is the transmitted mass of the molecules, vx, vy and vz show the ﬂow velocities at the
corresponding x, y and z coordinates, respectively, Dx, Dy, Dz are the diffusion coefﬁcients at the
corresponding coordinate given at their subscript and x0, y0 and z0 are the transmission points in three
dimensions. In (3), the estimation of the localized velocity terms with respect to time and space is a
difﬁcult problem which is beyond the scope of this paper. The practical conditions make this estimation
problem more complicated due to the reasons given as follows.
In a practical indoor scenario, it is not sufﬁcient to use only Brownian motion due to the effects such as
boundary conditions and the initial velocity of the molecules. It is also very difﬁcult to determine whether

7
the indoor boundaries with various geometries are absorber or reﬂector. The models in (1-3) need to be
modiﬁed to consider these effects. Furthermore, these modiﬁcations may not be sufﬁcient to model the
practical indoor scenario, since alcohol molecules are sprayed as liquid droplets and they are subject to
gravity and the observed phenomena about the unsteady ﬂows, e.g., turbulent ﬂows, in which the velocity
of the droplets is not constant according to time. The details about these ﬂows are given in Section VII.
It is highly difﬁcult to derive an analytical expression, which can take all of the aforementioned effects
into account, for channel parameter estimation such as distance. Therefore, it is reasonable to use the
alternative practical methods such as data analysis, linear regression and neural networks for estimating
the distance accurately. With these methods, these effects on the collected signals are implicitly modeled
and employed for distance estimation. Next, the experimental procedure is explained to collect data and
implement distance estimation methods.
III. EXPERIMENTAL SETUP AND DATA COLLECTION
In this section, the experimental setup of a practical macroscale MC system is explained in order
to collect data for distance estimation. This system consists of a transmitter (TX), a receiver (RX)
and a propagation channel similar to the tabletop molecular communication system in [6]. However,
unlike [6], there is no fan in our system. The TX transmits molecular signals by spraying ethyl alcohol
with an Instapark electric sprayer. This sprayer has its own battery in it and can be controlled with a
microcontroller via a custom switch circuit. The RX receives the molecular signals with an MQ-3 alcohol
sensor which gives the best performance among the low-cost metal oxide alcohol sensors [6]. The TX and
RX are both controlled with an Arduino Uno microcontroller board which is connected to a computer.
The block diagram of the system is given in Fig. 2. As shown in this diagram, only one microcontroller
board and one computer is used for simplicity and perfect synchronization between the TX and RX.
The TX is controlled with a computer via an Arduino microcontroller board so that the spraying
duration, i.e., emission time (Te), can be arranged. The TX and RX were 100 cm high from the ground
and the experiments were carried out in a laboratory. After the TX transmits a signal, the molecules begin
to diffuse in the air with an initial velocity supplied by the TX. In addition, it is observed that some of
the liquid droplets fall to the ground as soon as they are emitted during the experiments. The droplets
coming out of a sprayer can be affected by the gravity due to their size [27]. Since the molecules are
transmitted as sufﬁciently large liquid droplets, it is deduced that they are affected by the gravity.
When the TX stops transmitting, the RX starts to record the molecular signal for 100 seconds for
distances up to 180 cm and 300 seconds for longer distances. The molecule concentration in the environ-
ment is sensed by the MQ-3 sensor and analog voltage values corresponding to the measured molecule

8
Electric
Sprayer
MQ­3 Sensor
Arduino Uno
Microcontroller
Board 
Computer
Transmitter 
Receiver
Channel
Text
Text
Custom Switch
Circuit
Fig. 2: Block diagram of the experimental setup.
concentration are sent to the Arduino microcontroller board. This analog signal is digitized with a 10-bit
analog to digital converter by the microcontroller board. Finally, the received signal is sent to the computer
from Arduino microcontroller board to be recorded. The components of the TX and RX can be seen in
Fig. 3. Moreover, the variables which are used in Sections III, IV and VI are summarized in Table I.
Fig. 3: Components of the transmitter (left) and the receiver (right).
During the experiments, only one single puff is transmitted from the TX to estimate the distance for one
measurement. The transmissions are repeated for three different emission times as Te = {0.25, 0.5, 0.75}
s and eleven different distances between 100 cm and 200 cm with 10 cm steps. The parameter ranges and
replication numbers for the experiment are given in Table II. A break was taken for at least 5 minutes
between consecutive measurements. During this break, the laboratory is ventilated by opening the door
and the window to reduce the molecule concentration level inside the laboratory. By the help of this

9
TABLE I: Summary of the variables used in Sections III, IV and VI.
Variable
Deﬁnition
Te
Emission time
d
Actual Distance
ˆd
Estimated distance
Ao
Initial offset level
Athr
Threshold amplitude
K
Detection threshold
C[n]
Measured molecule concentration
y[n]
Output of the moving average ﬁlter
W1
The number of samples before the nth sample of the moving average ﬁlter
W2
The number of samples after the nth sample of the moving average ﬁlter
tpeak
Peak time
Cpeak
Peak molecule concentration
tlow
Time showing the 10% reference point on the rising edge of the measured signal
Clow
Molecule concentration showing the 10% reference point on the rising edge of the
measured signal
thigh
Time showing the 90% reference point on the rising edge of the measured signal
Chigh
Molecule concentration showing the 90% reference point on the rising edge of the
measured signal
R
Rise time on the rising edge of the measured signal
∆C
Molecule concentration level difference between Chigh and Clow
G
Gradient on the rising edge of the measured signal
NR
Number of the received signal samples up to tpeak
ER
Received energy up to tpeak
PR
Received power up to tpeak
PT
Transmitted power
PR
Average received power
PT
Average transmitted power
a1, b1
Curve ﬁtting parameters of power based estimation
tpeak
Average peak time
a2, b2
Curve ﬁtting parameters of peak time based estimation
“break and ventilate” procedure, the effect of the remaining molecules from previous transmissions is
minimized. Without applying this procedure, the noise level increases and thus, it gets more difﬁcult to
detect the signal by the RX side. In order to estimate the distance between the TX and RX, it is essential
to extract the features from the signals to employ them as inputs to ML methods, as discussed in the
next section.

10
TABLE II: The experimental parameters and their ranges.
Parameter
Value
Te
{0.25, 0.5, 0.75} s
d
{100, 110, 120,..., 190, 200} cm
Replication for each Te in every distance
10
Replication for each distance
30
Number of total measurements
330
IV. FEATURE EXTRACTION
In this section, a novel feature extraction algorithm is proposed. This algorithm processes the received
molecular signals to produce features, which can be deﬁned as the input variables characterizing the
output variable to be estimated for ML algorithms [28]. The choice of the features is important, since it
effects the performance of the ML algorithms. Eight features which are tlow, Clow, R, ∆C, G, tpeak, Cpeak
and ER are extracted from the collected data. Three of the measured signals at 100, 160 and 200 cm are
shown in Fig. 4 in order to justify the choice of the selected features. In this ﬁgure, the delay time, which
is deﬁned as the beginning time of the detection of the transmitted molecules, increases, as the distance
increases. tlow gives a more reliable information about the delay time due to the ﬂuctuations of the signal.
Clow also decreases, as the distance increases. Since the signal attenuates as the distance increases, the
peak points (tpeak, Cpeak) and the received energy (ER) of the signals contain information about the
distance. Furthermore, as the distance increases, the slope of the signals’ rising edge decreases. This
shows that R, ∆C and G are informative features. To the best of our knowledge, the proposed feature
extraction algorithm which is summarized in Fig. 5, is the ﬁrst one that processes the real measured
molecular signals.
0
10
20
30
40
50
60
70
80
90
100
Time (s)
0
0.5
1
1.5
2
2.5
3
Molecule Concentration Level (Volts)
0
10
20
30
40
50
60
70
80
90
100
Time (s)
0.2
0.4
0.6
0.8
1
1.2
1.4
1.6
Molecule Concentration Level (Volts)
0
10
20
30
40
50
60
70
80
90
100
Time (s)
0.44
0.46
0.48
0.5
0.52
0.54
0.56
0.58
0.6
0.62
0.64
Molecule Concentration Level (Volts)
(a)
(b)
(c)
Fig. 4: Received signal at (a) d = 100 cm , (b) d = 160 cm (c) d = 200 cm.

11
Start
Record the received
signal from the
MQ-3 sensor
Determine the initial
offset level (Ao)
Set the threshold,
K for detection.
K = Ao + Athr
Smooth the signal
by a moving
average ﬁlter
Detection:
Is there
any
sample
above the
threshold,
K ?
Wait for the new
received signal
Detect the ﬁrst peak
point of the signal
Detect the nearest
local minimum
point before the ﬁrst
peak of the signal
Extract the features:
tlow, Clow, R, tpeak,
Cpeak, ∆C, G
Calculate the energy
of the received signal
(ER) up to tpeak s
Send the values
of the features to
machine learning
methods as inputs
Stop
no
yes
Fig. 5: Feature Extraction Algorithm.
As the ﬁrst step of the feature extraction algorithm, Ao, which is deﬁned as the initial offset level
characterized by the average of the measured sensor voltage, is determined. Ao is calculated by averaging
the ﬁrst p samples of the signal, before the transmitted molecules start to be sensed by the RX. In
order to avoid considering the transmitted molecules by the TX, p is selected as 5 empirically for our
experimental scenario. The molecule concentration level is measured as the voltage values received from
the MQ-3 sensor. Ao corresponds to the average molecule concentration level which is measured before
the transmitted signal arrives. After Ao is determined, the detection threshold is given by the equation
K = Ao + Athr,
(4)
where Athr is set to 0.1 volts. The value of Athr is chosen sufﬁciently high according to our observations
in order to detect the transmitted signal. The derivation of a selection criterion for Athr requires to handle

12
the related detection theory together with the probability distributions of the observed molecular signals.
This is beyond the scope of this paper. Subsequently, smoothing the received signal is needed due to the
ﬂuctuations in the signal orginated from the random movements of the molecules. The signal is smoothed
by ﬁltering with a moving average ﬁlter whose input-output relationship is given by [29]
y[n] =
1
1 + W1 + W2
W2
X
k=−W1
C[n −k].
(5)
Here, (W1 +W2 +1) gives the window size which is chosen as 7 by setting W1 = W2 = 3. This window
size is chosen empirically in order to eliminate the ripples on the signal without changing its general
shape. Increasing the window size makes the signal smoother. However, if the the window size is greater
than 7, the values of the extracted features begin to diverge from their original values. Subsequent to
smoothing operation, the detection block is accomplished. In this block, a decision is made whether the
signal is above the predetermined K or not. If there is no detection, then the RX waits for the new signal.
Otherwise, the ﬁrst peak of the signal is detected. According to our observations, there can be more than
one peak in the received signal, after the redundant peaks are eliminated by the smoothing ﬁlter. The
number of these peaks increase as the distance increases, since the variance of the time distribution that
the molecules take to reach the sensor is getting larger. The ﬁrst peak time is considered as the reference
time to calculate the features, since it is assumed that the majority of the molecules arrive at the RX until
the ﬁrst peak time. In order to ﬁnd the ﬁrst peak point of the signal, the ﬁrst derivative of the signal’s
samples is taken. The ﬁrst negative sample index at the point where the sign of the ﬁrst derivative changes
from positive to negative values gives the peak of the signal. After that, the nearest local minimum point
before the ﬁrst peak of the signal is detected. The same method to ﬁnd the peak point of the signal can
be used to ﬁnd the ﬁrst minimum point of the signal. When the signal is inverted, the ﬁrst peak point
gives the ﬁrst minimum point of the signal. The features extracted from the ﬁrst peak of the signal are
shown in Fig. 6. Here, the peak time and molecule concentration values are recorded as tpeak and Cpeak,
respectively. Afterwards, the part of the signal which is between the peak and minimum points is treated
as the rising edge of a pulse. The positive-going bilevel waveform consisting of high and low levels is
obtained to extract the information which can change according to distance. As illustrated in Fig. 6, 10%
reference point of the signal gives two features as tlow and Clow and similarly 90% reference point of
the signal is chosen to represent thigh and Chigh. These reference points are found by calculating the
points at 10% and 90% of the time indices for the time interval between the peak and minimum points.
The rise time (R) of this waveform is calculated by measuring the time between tlow and thigh. Another
extracted feature for this signal is ∆C which is deﬁned as the difference in the amplitude level during
the rise time measurement points.

13
1
1.5
2
2.5
3
3.5
4
Time (seconds)
0
0.5
1
1.5
2
2.5
3
Level (Volts)
rise time
signal
upper cross
lower cross
upper boundary
upper state
lower boundary
upper reference
lower reference
upper boundary
lower state
lower boundary
(thigh, Chigh)
(tpeak, Cpeak)
(tlow, Clow)
Rise time
C
Fig. 6: Extracted features from the received signal.
The seventh feature is the gradient, which is derived by G = ∆C/R. G gives the change during the
rise time, which can be discriminating according to different distances. Finally, the received energy up
to tpeak is calculated by the formula
ER =
NR
X
n=1
|C[n] −Ao|2.
(6)
In this formula, the received molecule concentration level is decreased by the existing noise level to
eliminate its effect. Furthermore, the energy is found up to tpeak, since the time-dependent function of
the concentration values has a long tail and it gets much longer, as the distance increases. In the next
section, the ML algorithms that is used in this paper is introduced.
V. SUPERVISED MACHINE LEARNING METHODS FOR DISTANCE ESTIMATION
ML has a key role in science and engineering, since it facilitates the estimation of the desired outputs
without changing the system model for changing inputs. It provides the ability to improve the estimation
models adaptively which is called “learning”. When the inputs and outputs are known during the training
of the ML system, it is called “supervised” learning. In supervised ML, classiﬁcation and regression are
two ways of estimation where the former tries to estimate the discrete results for a discrete output and
the latter deals with the estimation of the results of a continuous output. In this paper, ML techniques,
such as MLR and NNR are used for the ﬁrst time to estimate the distance between a TX and an RX in
a MC system. Next, the mentioned ML methods are introduced brieﬂy.

14
A. Multivariate Linear Regression
MLR is a simple method to estimate the output according to the model equation given below
ˆd = θ0 +
m
X
j=1
θjxj,
(7)
where θ0 is the bias, m is the number of the features, xj’s and θj’s represent the features and the unknown
coefﬁcients, respectively [30]. (7) can also be expressed in matrix form as
ˆd = xθ,
(8)
where x is an N ×(m+1) matrix of features, θ is a column vector of (m+1) elements representing the
coefﬁcients, ˆd is a column vector of N elements showing the estimated distance and N is the number
of samples. Each row of x shows one sample having an extra 1 as the ﬁrst element of each row. N
represents the number of training samples for the training period and the number of test samples while the
distance is estimated using (8). The model coefﬁcients are chosen during the training period to minimize
the cost function given by the formula below
J(θ) = 1
N
N
X
i=1
(di −ˆdi)2,
(9)
By using the least squares method in the training period, the coefﬁcients are determined by
θ = (xT x)−1xT d,
(10)
where d is a column vector with N elements showing the actual distances for training. After ﬁnding the
coefﬁcients by the training according to (10), the distance can be estimated by (8) where N shows the
number of test samples.
B. Neural Network Regression
NNR is a ML method inspired by the neurons in the brain. It has a layered structure which includes
an input layer, one or more hidden layers and an output layer. These layers consist of nodes like neurons
connecting the input layer to the output layer with weights [30]. As illustrated in Fig. 7, the weights
(Θ’s) are arranged as the elements of a function that maps the input values (xi) to an output value, which
is the estimated distance ( ˆd) in our case, with minimum error.
The relation between the input layer and the hidden layer (aj) can be given by
a(k)
j
= g
 n
X
i=0
θ(k)
ji xi
!
,
(11)

15
x1 
xn 
. 
. 
. 
Input
Layer
Hidden
Layer
Output
Layer
Text
Text
Text
a1
(2) 
ap
(2) 
. 
. 
. 
x2 
^d 
x0 
a0
(2) 
 
Θ(1)
ji
 
Θ(2)
1j
Text
a2
(2) 
Fig. 7: General structure of a neural network for regression with one output node and a single hidden
layer.
where θ(k)
ji
shows the weight that connects the ith node to the jth node between the layers (k) and
(k + 1), a(k)
j
is the jth hidden node in the kth layer, xi is the input values deﬁned from 0 to n and g(.)
is the activation function. The relation between the hidden layer and the output layer can be deﬁned as
ˆd = g


p
X
j=0
θ(k)
ji xi

,
(12)
where the number of the hidden nodes in the hidden layer is deﬁned from 0 to p. Here, the input and
hidden nodes with the subscript “0” are deﬁned as the bias units. In this paper, the hyperbolic tangent
sigmoid function is used as the activation function which is given by
g(z) =
2
1 + e−2z −1.
(13)
The training of the neural network can be made with backpropagation algorithms. In these algorithms,
the weights are initialized generally with random values and the output of the network is calculated in
the forward direction. Then, using the output and the values of the hidden nodes, the errors are calculated
in the reverse direction and the weights are arranged iteratively to obtain minimum error between the
estimated and actual output values. In this paper, Levenberg-Marquardt (LM) backpropagation algorithm,
which is one of the most popular and fastest algorithms, is employed to train the neural network [31].
Before giving the update mechanism of the LM algorithm, some deﬁnitions are made as follows. A
pattern is deﬁned as the number of the input-output pairs of the neural network. Each different path from

16
the input layer to the output layer gives a different pattern which is indexed from 1 to r. The training
error for the ith pattern is given by
ei = ri −oi,
(14)
where ri is the desired output and the oi is the trained output of the neural network for the ith pattern.
Moreover, the error vector (e) is given as
e =
h
e1
e2
. . .
er
iT
,
(15)
where ei is the training error for the ith pattern. Similarly, the sum of the squares function is given by
E(θ) = 1
2
r
X
i=1
e2
i ,
(16)
where θ is the weight vector of N elements representing all of the weights in the neural network. The
LM algorithm updates these weights to converge the minimum training error by minimizing E(θ). For
this operation, Jacobian matrix is used which can be given as
J =


∂e1
∂θ1
∂e1
∂θ2
. . .
∂e1
∂θN
∂e2
∂θ1
∂e2
∂θ2
. . .
∂e2
∂θN
...
...
...
...
∂er
∂θ1
∂er
∂θ2
. . .
∂er
∂θN


,
(17)
where θi represents the weights deﬁned from 1 to N. The weight update rule of the LM algorithm in
matrix form is given by
θl+1 = θl −
 JT
l Jl + µI
−1 Jlel,
(18)
where l is the index of iterations, I is the identity matrix, µ is a positive coefﬁcient related with the
learning rate.
In LM algorithm, E(θ) is computed and checked to see, if it decreases. If E(θ) decreases, then µ is
reduced by a step size γ which is a user deﬁned parameter. Otherwise, µ is increased by γ. The algorithm
continues to iterate until it reaches to a predetermined threshold value for E(θ) [31]. After the weights
are determined by the training with LM algorithm, the distance can be estimated by using (12). Next,
novel distance estimation methods based on data analysis are introduced.
VI. DISTANCE ESTIMATION METHODS BASED ON DATA ANALYSIS
The features extracted by the proposed algorithm in Section IV are employed to derive novel distance
estimation methods in this section. For the ﬁrst method, the relation among the average received power,
average transmitted power and the distance are exploited. Next, the average peak time and distance
relation is used for the second estimation method. Finally, these two methods are combined to derive the
third distance estimation method.

17
A. Power Based Distance Estimation
By using the received energy up to tpeak, which is calculated in Section IV, the received power (PR)
is calculated with the formula
PR = ER
NR
=
1
NR
NR
X
n=1
|C[n] −Ao|2.
(19)
PR is averaged over 10 measurements for each Te, i.e., 0.25 s, 0.5 s and 0.75 s, at each distance. Hence,
we obtain three average power (PR) values according to three different Te’s for each distance.
On the other hand, the transmitted power (PT ) is measured and averaged over 4 measurements for
3 different values of Te to obtain the average transmitted power (PT ). The measurements are made by
placing the sensor to a very close proximity of the TX, which is assumed to generate a rectangular
molecular pulse within Te. The measured transmitted signal for 0.25 s emission time, is shown in Fig.
8. PT values are 7.3598, 9.3666 and 11.0108 W for 0.25, 0.5 and 0.75 s emission times, respectively.
Afterwards, PR and PT values are employed to derive a relation with the distance between the TX and
RX. Fig. 9 shows that there is a decreasing exponential relation among these parameters for three different
emission times.
The relation between PR/PT and the distance is exploited to derive a function by using curve ﬁtting
techniques with the data illustrated in Fig. 9. The function deﬁning the relation between PR/PT and the
distance, is best ﬁtted for the curve ﬁtting model with the equation
PR
PT
= a1eb1d,
(20)
where a1 and b1 are the curve ﬁtting parameters. The curve ﬁtting is made by using nonlinear least
squares method which minimizes the sum of squared errors. LM algorithm, which is explained in detail in
0
0.5
1
1.5
2
2.5
Time (s)
1.5
2
2.5
3
3.5
4
4.5
Molecule Concentration Level (Volts)
Start of the
emission
End of the
emission for
Te = 0.25 s
Fig. 8: Transmitted signal for Te = 0.25s.

18
Section V, is used to estimate the a1 and b1 coefﬁcients in an iterative way. Furthermore, other algorithms
such as the Newton or Gauss-Newton (GN) can be employed for curve ﬁtting [32]. While the Newton
algorithm has a more stable convergence than the GN algorithm, it has a cost of calculating second order
derivatives. The GN algorithm is less complex, since it calculates ﬁrst order derivatives instead of second
order derivatives and thus, it has a faster (but less stable) convergence. The LM algorithm performs better
than the GN algorithm in terms of stability for convergence with the cost of higher complexity.
By using the LM algorithm, the measured data and their corresponding ﬁtted curves are given in Fig.
10 and the calculated a1 and b1 parameters with the Root Mean Square Error (RMSE) values for each
Te are given in Table III. As observed from the ﬁgure, the measured PR/PT decreases exponentially by
the distance. This relation can be employed to estimate the distance by pulling out d in (20) which is
given by
ˆd = 1
b1
ln
 PR
PT a1

,
(21)
where average power values are replaced with the measured power values and ln(.) shows the natural
logarithm.
100
110
120
130
140
150
160
170
180
190
200
Distance (cm)
0
0.05
0.1
0.15
0.2
0.25
Te = 0.25 s
Te = 0.5 s
Te = 0.75 s
Fig. 9: PR/PT vs. distance for different emission times.

19
0
20
40
60
80
100
120
140
160
180
200
220
Distance (cm)
0
0.02
0.04
0.06
0.08
0.1
0.12
0.14
Te = 0.25 s
data
fitted curve
0
20
40
60
80
100
120
140
160
180
200
220
Distance (cm)
0
0.05
0.1
0.15
0.2
0.25
Te = 0.5 s
data
fitted curve
0
20
40
60
80
100
120
140
160
180
200
220
Distance (cm)
0
0.02
0.04
0.06
0.08
0.1
0.12
0.14
0.16
0.18
Te = 0.75 s
data
fitted curve
(a)
(b)
(c)
Fig. 10: Measured PR/PT vs. the distance and their ﬁtted curves for (a) Te = 0.25 s, (b) Te = 0.5 s and
(c) Te = 0.75 s.
TABLE III: Curve ﬁtting parameters for power based distance estimation.
Te
a1
b1
RMSE
0.25 s
2.724
-0.03116
0.0096
0.5 s
13.4001
-0.04146
0.0211
0.75 s
3.1888
-0.02973
0.0171
B. Peak Time Based Distance Estimation
In this method, similar to the power based distance estimation, the extracted tpeak feature is averaged
over the measured values for each distance. The averaging is performed separately for three different
emission times as 0.25, 0.5 and 0.75 s. As observed in Fig. 11, there is an increasing exponential relation
between the average peak time and the distance. A function can be obtained by curve ﬁtting with the
formula given by
tpeak = a2eb2d,
(22)
where tpeak is the average peak time, a2 and b2 are curve ﬁtting parameters. An insertion is made to the
data for tpeak = 0 at d = 0 to obtain a more accurate curve. The same procedure is used for curve ﬁtting
as applied for power based distance estimation. According to (22), the ﬁtted curves are given in Fig. 12
for different emission times. By using these curve ﬁtting models, their parameters and RMSE values are
calculated as given in Table IV. Via the substitution of the measured peak time (tpeak) with tpeak, the
relation between the average peak time and the distance are employed to derive a distance estimation
model as given by
ˆd = 1
b2
ln
tpeak
a2

.
(23)

20
TABLE IV: Curve ﬁtting parameters for peak time based distance estimation.
Te
a2
b2
RMSE
0.25 s
1.1259
0.0178
6.6574
0.5 s
0.2401
0.0268
9.1950
0.75 s
0.5045
0.0221
7.7602
100
110
120
130
140
150
160
170
180
190
200
Distance (cm)
0
10
20
30
40
50
60
Te = 0.25 s
Te = 0.5 s
Te = 0.75 s
Fig. 11: Average peak time vs. distance for different emission times.
0
20
40
60
80
100
120
140
160
180
200
220
Distance (cm)
0
5
10
15
20
25
30
35
40
45
50
Te = 0.25 s
data
fitted curve
0
20
40
60
80
100
120
140
160
180
200
220
Distance (cm)
0
10
20
30
40
50
60
Te = 0.5 s
data
fitted curve
0
20
40
60
80
100
120
140
160
180
200
220
Distance (cm)
0
5
10
15
20
25
30
35
40
45
Te = 0.75 s
data
fitted curve
(a)
(b)
(c)
Fig. 12: Measured average peak time vs. the distance and their ﬁtted curves for (a) Te = 0.25 s, (b)
Te = 0.5 s and (c) Te = 0.75 s.
C. Combined Distance Estimation
The power based and peak time based distance estimation methods given in Section VI-A and VI-B,
respectively, can be combined to obtain a novel estimation method. When the ratio PR/PT to tpeak is
written by using the curve ﬁtting models in (20) and (22), the following equation is obtained.
PR
PT
tpeak
= a1eb1d
a2eb2d .
(24)

21
By the manipulation of (24), d can be derived as
ˆd =
1
b1 −b2
ln

PRa2
PT tpeaka1

,
(25)
which combines the power based and peak time based distance estimation methods. Next, the numerical
results are given for all of the methods given up to now.
VII. RESULTS AND ANALYSIS
In this section, numerical results are presented for distance estimation to analyze the performance of
ML methods given in Section V and the proposed data analysis based methods given in Section VI. First,
the numerical results of the ML and data analysis based methods are discussed. Then, these methods are
compared and an analysis about the experimental results are given.
A. Numerical Results
The aforementioned nine features, which are tlow, Clow, R, ∆C, G, tpeak, Cpeak, Te and ER, are given
as the input for training the ML methods. Here, all of the features except Te, are extracted as explained
in Section IV. Since Te is assumed to be known by the RX, it is also given as a feature. The Monte Carlo
simulations are performed 105 times for the ML algorithms to average the estimated distance values and
their errors. The data are divided randomly as 70% for training and 30% for testing in MLR. In NNR,
the data are randomly divided as 70% for training, 15% for validation and 15% for testing. Furthermore,
the hidden layer of the neural network has one node in the simulation model.
The performance comparison of the ML methods can be made for each distance. The mean estimated
distances and their standard deviations with respect to actual distance are given in Fig. 13, and 14 for MLR
and NNR, respectively. The points at each distance show the mean estimated values and the vertical bars
show their standard deviations. Moreover, a perfect estimation line is given to see how far the estimated
values approach to the actual values. The reason for giving these ﬁgures is to see especially the standard
deviations, i.e., to visualize how consistent the estimated values are. The NNR has slightly better results
than MLR for the mean estimated values and standard deviations. However, since the difference between
MLR and NNR results is small, it can be deduced that the relationship between the features used as
input and the distance is highly linear. The cost of the NNR method is its complexity and longer time
requirement. Hence, estimating the distance with MLR can be considered as an efﬁcient ML method due
to its simplicity and performance for our practical scenario and extracted features.
The performance evaluation of the proposed data analysis based distance estimation methods given in
Section VI, are made by using the features of the measured signals. The mean estimated distance values

22
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
80
100
120
140
160
180
200
Estimated Distance (cm)
Linear Regression
Actual Values
Fig. 13: Mean estimated distance and their standard deviations with linear regression for each distance.
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
80
100
120
140
160
180
200
Estimated Distance (cm)
Neural Network Regression
Actual Values
Fig. 14: Mean estimated distance and their standard deviations with neural network regression for each
distance.
and their standard deviations are shown in Figures 15, 16 and 17 for power based, peak time based and
combined estimation methods, respectively. The values for every actual distance on these ﬁgures show the
mean (dots) and standard deviation (vertical bars) values of the estimated distance over 30 measurements.
Due to the smaller number of features employed in data analysis based methods, the standard deviations
are relatively higher, when it is compared with the ML methods. There can be some unused parameters
in the data analysis based methods to estimate the distance more accurately with respect to the ML
methods. Next, all of the results is given in a comparable format to evaluate the performance of the
distance estimation methods given in this paper.

23
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
50
100
150
200
250
300
Estimated Distance (cm)
Power Based Estimation
Actual Values
Fig. 15: Mean estimated distances and their standard deviations for power based distance estimation.
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
40
60
80
100
120
140
160
180
200
220
Estimated Distance (cm)
Peak Time Based Estimation
Actual Values
Fig. 16: Mean estimated distances and their standard deviations for peak time based distance estimation.
B. Comparison
In Table V, the Root Mean Square Error (ρ) values are given for each method, which is deﬁned by
ρ =
v
u
u
t 1
M
M
X
i=1
( ˆdi −di)2,
(26)
where M is the number of the samples of the test data. In data analysis based methods, M is taken as
330 by using whole data samples. In ML methods, M represents the number of the samples of the test
data as deﬁned in the beginning of this section and ρ is averaged over 105 Monte Carlo simulation trials.
The results for ML methods are much better than the data analysis based methods. However, the cost of
the superiority of the ML methods emerge as time complexity which means that the ML methods require
more time and processing power for distance estimation calculations due to the longer equations used in

24
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
50
100
150
200
250
300
Estimated Distance (cm)
Combined Estimation
Actual Values
Fig. 17: Mean estimated distances and their standard deviations for combined distance estimation.
these methods. NNR has the highest complexity among the proposed methods. Furthermore, the training
phase of the ML methods can restrict real-time applications due to this complexity. Therefore, there is a
trade-off between the complexity and performance for the ML and data analysis based methods, which
needs to be optimized for the implementation of an application. On the other hand, the fact that the data
analysis based methods have less time complexity, makes the implementation of these methods easier
than the ML methods.
TABLE V: Distance estimation performance for the ML and data analysis based methods.
Method
RMSE
Linear Regression
21.4470
Neural Network Regression
20.1157
Power Based Estimation
62.3077
Peak Time Based Estimation
33.2434
Combined Estimation
44.3157
While the distance values increase, the same absolute error deviation has different meanings according
to the actual distance and the error values need to be normalized to determine which method is better.
Hence, mean absolute percentage error (MAPE) is preferred as the performance metric rather than the
absolute error deviation. For each actual distance, the MAPE (ϵ) values shown in Fig. 18 are calculated
according to the formula as given by
ϵ = 100
M
M
X
i=1
| ˆdi −d|
d
.
(27)

25
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
0
10
20
30
40
50
60
Mean Absolute Percentage Error (%)
Linear Regression
Neural Network Regression
Power Based Estimation
Peak Time Based Estimation
Combined Estimation
Fig. 18: Mean absolute percentage errors vs. actual distance for the ML and data analysis based methods.
In our practical scenario, our observations show that some of the droplets fall to the ground, before they
arrive to the RX. The droplets are sprayed from the TX as sufﬁciently large droplets to be affected by the
gravity [27]. Moreover, there are other effects such as boundary conditions in the diffusion process and
the initial velocity of the molecules. Since ML has more parameters to model these effects analytically,
they perform better than the data analysis based methods except the peak time based estimation method
at long distances. In general, the peak time based estimation provides the best performance among the
data analysis based methods. However, the peak time based estimation method has the worst performance
between 140 and 160 cm due to the non-linearity of the sensor as detailed in Section VII-C.
Unlike the other methods, peak time based estimation has a nearly linear estimation performance and
its MAPE decreases, as the distance increases. At 190 and 200 cm, it has very close values with ML
methods and even performs better than the ML methods at 200 cm. This result shows us that peak time
based estimation can be applied to longer distances. Furthermore, it reveals that the peak time provides
more accurate distance estimation, as the RX gets farther from the TX. Hence, the distance can be
estimated with more sensitive sensors for farther distances.
In order to determine the optimal distance estimation method for a practical scenario, the processing
capacity of the RX is essential. If the RX does not have the capacity to implement ML algorithms,
then the peak time based estimation method can be used with a cost of slightly higher error than ML
methods. Otherwise, MLR can be used as a more efﬁcient method between ML methods due to its lower
complexity and high accuracy. NNR has the best performance among all the proposed methods in terms
of accuracy, although it imposes the highest complexity. Next, our observations and numerical results are

26
analyzed to explain the phenomena behind the propagation of the molecules and its reception by the RX.
C. Analysis of the Results
The lowest MAPE values are between 140 and 180 cm for ML methods and between 140 and 160 cm
for data analysis based methods, except the peak time based estimation. The reason why the estimated
values are better within the interval 140 and 160 cm, lies in the measured signals. This can be more
clearly understood with the average velocity proﬁle of the transmitted molecules in the medium as shown
in Fig. 19. In order to calculate the average velocity of the molecules, it is assumed that the majority of
the molecules arrive at the RX, when the received molecule concentration is at its peak point. Although
some of the molecules reach the RX before or after this peak point, it is reasonable to choose tpeak as
the average arrival time of the molecules. Hence, the average velocity of the molecules is deﬁned as the
ratio of the distance to the time duration at which the peak concentration is read from the sensor. In Fig.
19, average velocities are obtained according to this deﬁnition for each Te and also the mean velocity is
given as the average of the velocity values given for three different values of Te.
100
110
120
130
140
150
160
170
180
190
200
Actual Distance (cm)
0
5
10
15
20
25
30
35
40
45
Average Velocity (cm/s)
Te=0.25s
Te=0.5s
Te=0.75s
Mean velocity
Fig. 19: Average velocity proﬁle of the transmitted molecules with respect to the actual distance.
1) The Effect of the Sensor’s Non-linearity: The larger velocities of the molecules for the measurements
between 140 and 160 cm can be related to the non-linearity of the sensor characteristics as given in Fig.
20. In this ﬁgure, Rs is the sensor resistance which changes according to the molecule concentration and
Ro is the sensor resistance measured at the concentration level 0.4 mg/L. The sensitivity of the sensor
is shown for different gases in logarithmic scale in Fig. 20 (a) [33]. The values in this ﬁgure for alcohol
is plotted in linear scale in Fig. 20 (b) to see the non-linearity of the sensor more clearly for our case.
The MQ-3 sensor makes more sensitive measurements in lower concentrations with respect to higher
concentrations. Due to this fact, the sensor can have errors for the measurements at lower distances.

27
Another possible explanation to understand the phenomena behind the motion of the molecules in our
scenario, can be made by employing the dynamics of the ﬂuid which is considered as follows.
0
1
2
3
4
5
6
7
8
9
10
Concentration (mg/L)
0
0.5
1
1.5
2
2.5
Rs/Ro
(a)
(b)
Fig. 20: Sensitivity characteristics of the MQ-3 sensor (Rs/Ro vs. Concentration) [33] (a) for different
gases in logarithmic scale (b) for alcohol in linear scale (plotted using original values from the datasheet).
2) The Effect of Factors Related to Fluid Dynamics: In ideal conditions where the molecules only
make an isotropic random walk without being exposed to any force, the diffusion process can be used to
model the movement of the molecules. However, the molecules come out of the TX as liquid droplets
with an initial velocity in our case. Thus, several processes concerning the dynamics of the ﬂuid can
occur and the diffusion process is not sufﬁcient to understand the motion of the molecules. Therefore,
the analysis is needed to be made in terms of ﬂuid dynamics.
When a liquid is sprayed into the air, the droplets initially come out of the sprayer with a certain angle
which is the beamwidth (spray angle) of the sprayer as shown in Fig. 21 with α. The interaction between
the transmitted droplets and the air molecules leads to a contraction in the effective beamwidth, which is
deﬁned as the angle of the propagating droplets as given in Fig. 21 with β. This interaction is detailed
as follows.
As the droplets move in the air due to the force applied by the sprayer, they gain a momentum, which
can be deﬁned as the product of the liquid’s mass and velocity. According to the law of momentum
conservation, when two objects are collided, their total momentum does not change before and after the
collision [34]. The collisions of the droplets with the air molecules cause aerodynamic drag which can be
deﬁned as the air force resisting the movement of the object [35]. The ethyl alcohol droplets slow down
due to the aerodynamic drag. Besides, the momentum lost by the droplets is gained by the air molecules

28
TX
Effective
beamwidth (β)
Beamwidth of
the sprayer (α)
Text
Text
Text
Text
Sprayer
Nozzle
Entrainment of the induced air flow
Droplet
Fig. 21: Beamwidth of the sprayer (TX) and the effective beamwidth.
due to the momentum conservation. The momentum exchange among the droplets and air molecules
generates an air ﬂow towards the center of the beamwidth along the horizontal axis [36]. This ﬂow
drags the droplets into the inner regions from the outer regions. Namely, the angle at which the droplets
propagate is reduced relative to the initial α angle, and this leads to a contraction. This contraction of
the droplets’ propagation angle facilitates turbulent ﬂows which is detailed as follows [37].
The ﬂows can be classiﬁed into two types as laminar ﬂow, which has parallel and regular streamlines,
and turbulent ﬂow, which has random and irregular streamlines [35]. Even if the effect of the turbulent
ﬂow can be observed, its mathematical modeling is still a big problem due to its complicated nature. The
ﬂow type of the ﬂuid depends on the Reynolds number (Re). In our case, Re is given as [37],
Re = 2|Vl −Va|a
νa
,
(28)
where a is the radius of the spherical droplet, νa is the kinematic viscosity of the air, Vl and Va are the
velocities of the liquid and airﬂow. Re inﬂuences the type of viscous ﬂows. As Re increases, it is more
likely to have a turbulent ﬂow in the medium. There is a critical value of Re to determine the ﬂow type
[38]. Above this critical value, which depends on the parameters of the transmitted molecules and the
medium, the ﬂow becomes turbulent. In order to determine where there is a turbulent ﬂow according to
(28), the radii of the liquid droplets, the velocities of the liquid droplets and air molecules are needed
to be measured, which is beyond the scope of this paper. High-speed photography techniques or Phase
Doppler Anemometry (PDA) can be used to measure the liquid droplet size and velocities. In [39], the
movement of the liquid gasoline fuel droplets after they come out of a sprayer (injector) is analyzed.
After the spraying operation, vortex ring-like structures, which include turbulent ﬂows, are observed
experimentally for the liquid droplets. As they move away from the sprayer, the average liquid droplet
size gets smaller [27]. Brownian motion does not have an important effect, if the droplet is large enough.
Hence, Brownian motion is more effective, after the velocity of the droplets decreases to a more steady

29
value. The ﬁndings and results in [39] can be used to analyze the movement of the droplets for our
scenario, since the densities of the gasoline fuel and ethyl alcohol have close values [40].
In the vicinity of the nozzle of the TX, the ﬂow of the droplets can be deﬁned as unsteady ﬂow,
since the velocity of the droplets are not constant with respect to time due to the interaction with the air
molecules [41]. Moreover, if a constant ﬂow is stopped suddenly, the ﬂow shows unsteady characteristic
[41]. Similarly in our case, since the TX suddenly stops its transmission at the end of Te, it can be
deduced that the ﬂow in our case becomes an unsteady ﬂow. As soon as molecules are emitted, they are
affected by the Brownian motion which can be neglected in the region where molecules are entrained
by the higher velocities of unsteady ﬂows such as turbulent ﬂows. As the droplets move away from the
TX, the aerodynamic drag decreases their velocities until a point where they start to move with only
Brownian motion. As the result of these movements and ﬁndings in [39], the transmitted droplets can be
expected to have a trajectory as illustrated in Fig. 22. Here, the motion of the droplets is divided into
two zones as the unsteady ﬂow zone and Brownian motion zone. In the ﬁrst zone, the droplets where
they travel a distance df, are affected by the unsteady ﬂows such as turbulent ﬂows. The droplets are
exposed to random ﬂuctuating aerodynamic drag forces due to the turbulent ﬂows [42]. When the effect
of the ﬂows ends, the droplets start to move with Brownian motion where they travel a distance dB
until the RX. Although gravity affects the motion of the droplets in both zones, its effect is greater in
the unsteady ﬂow zone, since the size of the droplets is larger. By using the trajectory in Fig. 22, the
velocity proﬁle in Fig. 19 can be explained as follows. For the measurements between 100 and 130 cm,
the non-linearity of the sensor can cause more measurement errors due to the lower sensitivity in higher
concentrations. In addition to this, the average distance traveled in the unsteady ﬂow zone can be larger
for the measurements between 140 and 160 cm than the average distance traveled in the unsteady ﬂow
zone for the measurements at other distances due to effects of the unsteady ﬂows. Thus, the droplets move
with larger velocities which cause shorter arrival time to the RX and a longer df than the measurements
at other distances. Consequently, these factors such as non-linear characteristic of the sensor and unsteady
ﬂows jointly affect the performance for distance estimation.
As given by the analysis about the unexpected average velocities of the molecules, their motion for
macroscale practical scenarios can be modeled by exploiting ﬂuid dynamics. The channel modeling and
parameter estimation with the ﬂuid dynamics point of view are open research issues for practical MC
scenarios. Next, the role of emission time, i.e., Te, is examined for distance estimation by using the
trajectory given in Fig. 22.
3) The Effect of the Emission Time: Fig. 19 for short distances up to 130 cm, the average velocity
of the molecules for Te = 0.5 s are greater than the average velocity of the molecules for Te = 0.25

30
RX
df 
dB 
Unsteady Flow Zone
Brownian Motion Zone
d
Droplet
Direction of Gravity
Text
Text
Text
TX
Text
Text
Sprayer
Nozzle
Fig. 22: The trajectory of the transmitted molecules between the TX and the RX.
s. However, for Te = 0.75 s, the average velocity is less than the molecules transmitted with Te = 0.5
s (except the nearly equal value at 120 cm). This result shows that there is an optimum Te for the
fastest propagation of the molecules according to the distance. Furthermore, it shows that sending more
molecules than this optimum Te can decrease the average velocity of the molecules. When Te is larger
than the optimum Te, a higher molecule concentration occurs in the unsteady ﬂow zone. This increases
the collision rate of the molecules and thus, reduces their velocity. For distances between 140 and 160 cm,
the average velocity is directly proportional with Te due to the above-mentioned longer average distance
traveled in the unsteady ﬂow zone. For long distances greater than 170 cm, Te does not signiﬁcantly
affect the average velocity of the molecules. Hence, it can be deduced from the results that an appropriate
Te should be chosen for a faster propagation according to the distance. More experimental research is
needed for the derivation of the optimum Te, which is left as a future work.
VIII. CONCLUSION
In this paper, ﬁve distance estimation methods are proposed for a practical macroscale MC system.
The existing two ML methods, which are linear and neural network regression, are applied in distance
estimation for the ﬁrst time. In order to use these methods, an experimental setup was established and
received signals were recorded. A novel feature extraction algorithm is proposed to generate training
and test data from the measured signals for the ML methods. By analyzing these generated data, three
novel methods for distance estimation are proposed and compared with the applied ML methods. The
ML methods result better than data analysis based methods, with NNR being the best method. However,

31
MLR has a very close performance to NNR, which shows that the input features such as peak time,
gradient of the received signal during the transition from the noise ﬂoor up to the peak time and the
received energy of the signal, have a linear relation with the distance. MLR can be an efﬁcient way for
distance estimation with high accuracy and low complexity as a ML method. Furthermore, data analysis
based methods perform worse, but are not as complex as ML methods. Especially, the peak time based
estimation performs close to ML methods, as the distance increases.
As a result of the experiments, the phenomena that cannot be explained with only the diffusion of
the molecules are revealed. The molecules are affected by the initial drift of the TX, Brownian motion
and gravity. Moreover, a possible trajectory of the molecules in which there are two propagation zones
as the unsteady ﬂow zone and the Brownian motion zone is given. It is analyzed that the transmitted
molecules are affected by unsteady ﬂows due to the induced air as soon as they are emitted from the TX.
Furthermore, our analysis shows that the non-linear characteristic of the sensor can cause measurement
errors. The joint effect of the non-linearity of the sensor and unsteady ﬂows complicates the estimation
of the distance at the RX side as revealed by the experimental data.
Hence, it can be concluded that a ﬂuid dynamics perspective is needed for a precise distance and any
other channel parameter estimation. It is also necessary to consider the imperfection of the TX and RX to
improve parameter estimation in macroscale practical MC system models. As the future work, we plan to
improve the channel parameter estimation performance by developing methods with the ﬂuid dynamics
perspective. Also, we plan to develop a method for the direction estimation of the TX by using multiple
sensors.
ACKNOWLEDGMENT
This work was supported by the Scientiﬁc and Technological Research Council of Turkey (TUBITAK)
under Grant 115E362.
REFERENCES
[1] B. Atakan, Molecular Communications and Nanonetworks, Springer, 2014.
[2] I. F. Akyildiz, F. Brunetti, C. Bl´azquez, Nanonetworks: A new communication paradigm, Computer Networks 52 (12)
(2008) 2260–2279.
[3] I. F. Akyildiz, J. M. Jornet, M. Pierobon, Nanonetworks: A new frontier in communications, Communications of the ACM
54 (11) (2011) 84–89.
[4] B. Atakan, O. B. Akan, S. Balasubramaniam, Body area nanonetworks with molecular communications in nanomedicine,
IEEE Communications Magazine 50 (1) (2012).
[5] L. P. Gin´e, I. F. Akyildiz, Molecular communication options for long range nanonetworks, Computer Networks 53 (16)
(2009) 2753–2766.

32
[6] N. Farsad, W. Guo, A. W. Eckford, Tabletop molecular communication: Text messages through chemical signals, PloS one
8 (12) (2013) e82935.
[7] N. Farsad, N.-R. Kim, A. W. Eckford, C.-B. Chae, Channel and noise models for nonlinear molecular communication
systems, IEEE Journal on Selected Areas in Communications 32 (12) (2014) 2392–2401.
[8] N.-R. Kim, N. Farsad, C.-B. Chae, A. W. Eckford, A universal channel model for molecular communication systems with
metal-oxide detectors, in: Communications (ICC), 2015 IEEE International Conference on, IEEE, 2015, pp. 1054–1059.
[9] S. Qiu, W. Guo, S. Wang, N. Farsad, A. Eckford, A molecular communication link for monitoring in conﬁned environments,
in: Communications Workshops (ICC), 2014 IEEE International Conference on, IEEE, 2014, pp. 718–723.
[10] C. Lee, B. Koo, N.-R. Kim, B. Yilmaz, N. Farsad, A. Eckford, C.-B. Chae, Molecular mimo communication link, in:
Computer Communications Workshops (INFOCOM WKSHPS), 2015 IEEE Conference on, IEEE, 2015, pp. 13–14.
[11] B.-H. Koo, C. Lee, H. B. Yilmaz, N. Farsad, A. Eckford, C.-B. Chae, Molecular mimo: From theory to prototype, IEEE
Journal on Selected Areas in Communications 34 (3) (2016) 600–614.
[12] H. Zhai, Q. Liu, A. V. Vasilakos, K. Yang, Anti-isi demodulation scheme and its experiment-based evaluation for diffusion-
based molecular communication, IEEE transactions on nanobioscience 17 (2) (2018) 126–133.
[13] D. T. McGuiness, S. Giannoukos, A. Marshall, S. Taylor, Parameter analysis in macro-scale molecular communications
using advection-diffusion, IEEE Access 6 (2018) 46706–46717.
[14] B. Atakan, O. B. Akan, An information theoretical approach for molecular communication, in: Bio-Inspired Models of
Network, Information and Computing Systems, 2007. Bionetics 2007. 2nd, IEEE, 2007, pp. 33–40.
[15] A. W. Eckford, Achievable information rates for molecular communication with distinct molecules, in: Bio-Inspired Models
of Network, Information and Computing Systems, 2007. Bionetics 2007. 2nd, IEEE, 2007, pp. 313–315.
[16] T. Nakano, Y. Okaie, A. V. Vasilakos, Transmission rate control for molecular communication among biological
nanomachines, IEEE Journal on Selected Areas in Communications 31 (12) (2013) 835–846.
[17] M. Pierobon, I. F. Akyildiz, Capacity of a diffusion-based molecular communication system with channel memory and
molecular noise, IEEE Transactions on Information Theory 59 (2) (2013) 942–954.
[18] M. Moore, T. Nakano, A. Enomoto, T. Suda, Measuring distance with molecular communication feedback protocols, Proc.
ICST BIONETICS (2010) 1–13.
[19] M. J. Moore, T. Nakano, A. Enomoto, T. Suda, Measuring distance from single spike feedback signals in molecular
communication, IEEE Transactions on Signal Processing 60 (7) (2012) 3576–3587.
[20] M. J. Moore, T. Nakano, Comparing transmission, propagation, and receiving options for nanomachines to measure distance
by molecular communication, in: Communications (ICC), 2012 IEEE International Conference on, IEEE, 2012, pp. 6132–
6136.
[21] J.-T. Huang, H.-Y. Lai, Y.-C. Lee, C.-H. Lee, P.-C. Yeh, Distance estimation in concentration-based molecular communi-
cations, in: Global Communications Conference (GLOBECOM), 2013 IEEE, IEEE, 2013, pp. 2587–2591.
[22] A. Noel, K. C. Cheung, R. Schober, Bounds on distance estimation via diffusive molecular communication, in: Global
Communications Conference (GLOBECOM), 2014 IEEE, IEEE, 2014, pp. 2813–2819.
[23] X. Wang, M. D. Higgins, M. S. Leeson, Distance estimation schemes for diffusion based molecular communication systems,
IEEE Communications Letters 19 (3) (2015) 399–402.
[24] X. Wang, M. D. Higgins, M. S. Leeson, An algorithmic distance estimation scheme for diffusion based molecular
communication systems, in: Communications (ICC), 2015 IEEE International Conference on, IEEE, 2015, pp. 1134–1139.
[25] L. Lin, Z. Luo, L. Huang, C. Luo, Q. Wu, H. Yan, High-accuracy distance estimation for molecular communication systems
via diffusion, Nano Communication Networks 19 (2019) 47–53.

33
[26] W. H. Bossert, E. O. Wilson, The analysis of olfactory communication among animals, Journal of theoretical biology 5 (3)
(1963) 443–469.
[27] N. De Cock, M. Massinon, S. O. Salah, F. Lebeau, Investigation on optimal spray properties for ground based agricultural
applications using deposition and retention models, Biosystems engineering 162 (2017) 99–111.
[28] M. B. Christopher, Pattern Recognition and Machine Learning, Springer-Verlag New York, 2016.
[29] A. V. Oppenheim, Discrete-time signal processing, Pearson Education India, 1999.
[30] J. Friedman, T. Hastie, R. Tibshirani, The elements of statistical learning, Springer series in statistics New York, 2008.
[31] M. T. Hagan, M. B. Menhaj, Training feedforward networks with the marquardt algorithm, IEEE transactions on Neural
Networks 5 (6) (1994) 989–993.
[32] P. C. Hansen, V. Pereyra, G. Scherer, Least squares data ﬁtting with applications, JHU Press, 2013.
[33] Hanwei Electronics Co. Ltd., Technical Data of MQ-3 Gas Sensor.
[34] D. Kleppner, R. Kolenkow, An introduction to mechanics, Cambridge University Press, 2013.
[35] J. D. Anderson Jr, Fundamentals of aerodynamics, Tata McGraw-Hill Education, 2016.
[36] P. Rothe, J. Block, Aerodynamic behavior of liquid sprays, International Journal of Multiphase Flow 3 (3) (1977) 263–272.
[37] S. Ghosh, J. C. R. Hunt, Induced air velocity within droplet driven sprays, Proc. R. Soc. Lond. A 444 (1920) (1994)
105–127.
[38] K. Avila, D. Moxey, A. de Lozar, M. Avila, D. Barkley, B. Hof, The onset of turbulence in pipe ﬂow, Science 333 (6039)
(2011) 192–196.
[39] S. Begg, F. Kaplanski, S. Sazhin, M. Hindle, M. Heikal, Vortex ring-like structures in gasoline fuel sprays under cold-start
conditions, International Journal of Engine Research 10 (4) (2009) 195–214.
[40] J. Maˇr´ık, M. Pexa, M. Kotek, V. H¨onig, et al., Comparison of the effect of gasoline-ethanol e85-butanol on the performance
and emission characteristics of the engine saab 9-5 2.3 l turbo, Agronomy Research 12 (2) (2014) 359–366.
[41] B. R. Munson, D. F. Young, T. H. Okiishi, W. W. Huebsch, Fundamentals of ﬂuid mechanics, John Wiley & Sons, 2009.
[42] M. Maxey, The gravitational settling of aerosol particles in homogeneous turbulence and random ﬂow ﬁelds, Journal of
Fluid Mechanics 174 (1987) 441–465.
